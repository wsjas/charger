<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="description" content="موقع المصنع + متجر المنتجات بواجهة حديثة وأداء سريع، مع مقارنة الإصدارات والأسئلة الشائعة." />
  <meta name="theme-color" content="#1677ff" />
  <meta name="robots" content="index,follow" />
  <link rel="canonical" href="./" />
  <link rel="manifest" href="./manifest.json">

  <title>XCharger | Factory</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <style>
    :root{
      --bg:#f5f7fa;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --primary:#1677ff;
      --primary2:#00d2d3;
      --line:rgba(15,23,42,.08);
      --shadow:0 18px 60px rgba(2,8,23,.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:"Cairo",system-ui,-apple-system,Segoe UI,Arial; background:var(--bg); color:var(--text);}
    a{color:inherit}
    .container{width:min(1150px,92vw); margin:0 auto;}
    header{
      position:fixed; inset-inline:0; top:0; z-index:50;
      background:rgba(255,255,255,.82);
      backdrop-filter: blur(14px);
      border-bottom:1px solid var(--line);
    }
    .nav{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:12px 0;}
    .brand{display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.2px; text-decoration:none;}

    .brand-icon{
      width:36px;height:36px; border-radius:12px;
      object-fit:contain;
      background:rgba(255,255,255,.85);
      box-shadow:0 8px 18px rgba(2,8,23,.18);
      padding:4px;
      display:none;
    }
    body.has-brand-icon .brand-icon{display:block;}

    .brand i{color:var(--primary)}
    .brand span{color:var(--primary)}
    .menu{display:flex; align-items:center; gap:14px; flex-wrap:wrap}
    .menu a{text-decoration:none; font-weight:800; color:var(--text); opacity:.85; padding:8px 10px; border-radius:12px}
    .menu a:hover{background:rgba(2,8,23,.04); opacity:1}
    .actions{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; border:1px solid var(--line); background:rgba(255,255,255,.9); font-weight:900;}
    .btn{border:0; cursor:pointer; font-weight:900; border-radius:999px; padding:10px 14px; display:inline-flex; align-items:center; gap:9px;}
    .btn-primary{background:var(--primary); color:#fff; box-shadow:0 14px 30px rgba(22,119,255,.22)}
    .btn-primary:hover{filter:brightness(.97)}
    .btn-ghost{background:#fff; border:1px solid var(--line); color:var(--text)}
    .btn-ghost:hover{background:rgba(2,8,23,.03)}
    .chip{font-weight:900; padding:7px 10px; border-radius:999px; border:1px solid var(--line); background:#fff; cursor:pointer}
    .chip.active{background:rgba(22,119,255,.10); border-color:rgba(22,119,255,.25); color:var(--primary)}

    .hero{padding-top:86px;}
    .hero-wrap{
      margin-top:10px;
      border-radius:28px;
      overflow:hidden;
      background:
        linear-gradient(135deg, rgba(2,8,23,.78), rgba(22,119,255,.28)),
        url("https://images.unsplash.com/photo-1593941707882-a5bba14938c7?auto=format&fit=crop&w=1600&q=80") center/cover;
      box-shadow: var(--shadow);
      min-height: 420px;
      display:flex;
      align-items:center;
    }
    .hero-inner{padding:44px 22px; width:100%;}
    .hero h1{margin:0 0 10px; color:#fff; font-size:clamp(28px,4.2vw,52px); line-height:1.1; font-weight:900;}
    .hero p{margin:0 0 18px; color:rgba(255,255,255,.9); max-width:780px; font-size:clamp(14px,1.25vw,18px); font-weight:700}
    .hero-cta{display:flex; gap:10px; flex-wrap:wrap}
    .hero .btn-ghost{background:rgba(255,255,255,.10); border-color:rgba(255,255,255,.18); color:#fff}
    .hero .btn-ghost:hover{background:rgba(255,255,255,.14)}

    .stats{margin-top:-34px; background:var(--bg); position:relative; z-index:3; padding:0 0 18px;}
    .stats-grid{display:grid; grid-template-columns: repeat(4,minmax(0,1fr)); gap:12px}
    .stat{background:rgba(255,255,255,.80); backdrop-filter: blur(10px); border:1px solid var(--line); border-radius:18px; padding:14px 14px; box-shadow:0 10px 30px rgba(2,8,23,.06); display:flex; align-items:center; gap:12px}
    .stat i{color:var(--primary)}
    .stat .k{font-weight:900}
    .stat .v{font-weight:900; color:var(--muted); font-size:13px}

    section{padding:54px 0}
    .title{text-align:center; margin-bottom:18px}
    .title h2{margin:0; font-size:28px; font-weight:900}
    .title p{margin:10px 0 0; color:var(--muted); font-weight:800}
    .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:0 12px 38px rgba(2,8,23,.06);}
    .grid-2{display:grid; grid-template-columns: 1fr 1fr; gap:16px}

    .products{display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:16px; margin-top:18px}
    .p-card{padding:16px; display:flex; flex-direction:column; gap:12px}
    .p-top{display:flex; flex-direction:column; gap:12px; align-items:stretch}
    .p-img{width:100%; height:280px; border-radius:18px; background:#ffffff; border:1px solid var(--line); display:flex; align-items:center; justify-content:center; overflow:hidden; padding:10px}
    .p-img img{width:100%; height:100%; display:block; object-fit:contain; object-position:center; background:transparent}

    .p-price-row{display:flex; align-items:center; gap:10px; margin-top:6px}
    .p-old{font-weight:900; color:#ef4444; text-decoration:line-through; font-size:13px; margin-top:2px}
    .p-discount{font-weight:900; font-size:12px; padding:6px 10px; border-radius:999px;
      background:#fee2e2; color:#b91c1c; border:1px solid rgba(185,28,28,.18)}
    .p-name{font-weight:900; font-size:18px; margin:0}
    .p-badge{display:inline-flex; gap:8px; align-items:center; font-weight:900; color:#0b1220; background:rgba(22,119,255,.10); border:1px solid rgba(22,119,255,.20); padding:6px 10px; border-radius:999px}
    .p-price{font-weight:900; font-size:20px}
    .muted{color:var(--muted); font-weight:800}
    .feat{margin:0; padding:0; list-style:none; display:grid; gap:8px}
    .feat li{display:flex; gap:10px; align-items:flex-start; font-weight:800; color:#334155}
    .feat i{color:#16a34a; margin-top:4px}
    .p-specs{margin-top:10px}
    .p-specs b{display:block;margin-bottom:6px;font-weight:1000}
    .spec{margin:0;padding:0 18px;display:grid;gap:6px}
    .spec li{list-style:disc;color:var(--muted);font-weight:800}

    .p-actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px}
    .p-actions .btn{padding:9px 12px; border-radius:14px}

    .table-wrap{overflow:auto}
    table{width:100%; border-collapse:collapse; min-width:780px}
    th,td{padding:12px 12px; border-bottom:1px solid var(--line); text-align:right; font-weight:800}
    th{background:#f8fafc; position:sticky; top:0; z-index:1}
    td small{color:var(--muted); font-weight:900}

    #adminPanel{display:none}
    .admin-grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:16px; margin-top:16px}
    .admin-card{padding:16px}
    .field{display:grid; gap:7px; margin-bottom:12px}
    label{font-weight:900; color:#0b1220}
    input,textarea,select{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      font-family:inherit;
      font-weight:800;
      outline:none;
    }
    textarea{min-height:94px; resize:vertical}
    input:focus,textarea:focus,select:focus{border-color:rgba(22,119,255,.45); box-shadow:0 0 0 4px rgba(22,119,255,.10)}
    .admin-list{display:grid; gap:10px}
    .item{display:flex; justify-content:space-between; align-items:center; gap:12px; padding:12px; border-radius:16px; border:1px solid var(--line); background:#fff}
    .item .meta{display:grid; gap:2px}
    .item .meta b{font-weight:900}
    .item .meta span{font-weight:900; color:var(--muted); font-size:12px}
    .item .row{display:flex; gap:8px; flex-wrap:wrap}
    .danger{background:#fff; border:1px solid rgba(239,68,68,.25); color:#b91c1c}

    footer{background:#0b1220; color:#cbd5e1; padding:34px 0;}
    .foot{display:grid; grid-template-columns: 1.3fr 1fr 1fr; gap:18px}
    .foot h3,.foot h4{margin:0 0 10px; color:#fff}
    .social{display:flex; gap:10px; flex-wrap:wrap}
    .iconbtn{width:40px; height:40px; border-radius:14px; border:1px solid rgba(255,255,255,.12); display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,.06); text-decoration:none}

    .copy{margin-top:18px; padding-top:16px; border-top:1px solid rgba(255,255,255,.08); text-align:center; font-weight:800; color:#94a3b8}

    .modal{display:none; position:fixed; inset:0; z-index:60; background:rgba(2,8,23,.55); padding:18px}
    .modal-inner{max-width:420px; margin:80px auto 0; background:#fff; border-radius:22px; border:1px solid var(--line); box-shadow: var(--shadow); padding:18px}
    .modal-head{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .modal-head h3{margin:0; font-weight:900}
    .x{border:0; background:transparent; font-size:22px; cursor:pointer}
    .hint{margin-top:12px; font-weight:900; color:#b45309; background:#fff7ed; border:1px solid rgba(180,83,9,.18); padding:10px 12px; border-radius:16px; display:none}

    @media (max-width:980px){
      .stats-grid{grid-template-columns: repeat(2,minmax(0,1fr));}
      .admin-grid{grid-template-columns: 1fr;}
      .foot{grid-template-columns:1fr;}
    }
    @media (max-width:720px){
      .products{grid-template-columns:1fr}
      .menu{display:none}
      .hero-inner{padding:34px 16px}
    }
  
    /* Cart */
    .cart-count{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:22px;
      height:22px;
      padding:0 6px;
      border-radius:999px;
      background:rgba(22,119,255,.12);
      border:1px solid rgba(22,119,255,.28);
      color:var(--primary);
      font-weight:900;
      font-size:12px;
      line-height:1;
    }
    .cart-line{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding:12px;
      border:1px solid var(--line);
      border-radius:16px;
      background:#fff;
    }
    .qty{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      border-radius:14px;
      padding:6px 8px;
      background:#fff;
      user-select:none;
    }
    .qty button{
      width:30px;height:30px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-weight:900;
    }
    .qty span{min-width:16px;text-align:center;font-weight:900}
    .cart-total{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#f8fafc;
      font-weight:900;
    }
    .cart-note{font-weight:800;color:var(--muted); font-size:13px}
    .modal-inner.wide{max-width:560px}

  
  /* ===== Hero Slider (admin-controlled) ===== */
  .hero-wrap{
    position:relative;
    margin-top:10px;
    border-radius:28px;
    overflow:hidden;
    box-shadow: var(--shadow);
    min-height: 420px;
    display:flex;
    align-items:stretch;
  }
  .hero-slider{
    position:absolute;
    inset:0;
    z-index:0;
  }
  .hero-slider .slide{
    position:absolute;
    inset:0;
    display:block;
  }
  .hero-slider img{
    width:100%;
    height:100%;
    object-fit:cover;
    filter:saturate(1.05);
  }
  .hero-slider::after{
    content:"";
    position:absolute;
    inset:0;
    background:linear-gradient(135deg, rgba(2,8,23,.78), rgba(22,119,255,.28));
  }
  .dots{
    position:absolute;
    bottom:14px;
    inset-inline:14px;
    display:flex;
    gap:8px;
    z-index:2;
  }
  .dot{
    width:10px;height:10px;border-radius:999px;
    border:1px solid rgba(255,255,255,.55);
    background:rgba(255,255,255,.18);
    cursor:pointer;
  }
  .dot.active{
    background:#fff;
    border-color:#fff;
  }
  .hero-inner{ position:relative; z-index:1; padding:44px 22px; width:100%; }
/* Slider caption */
.slide-caption{
  position:absolute;
  inset-inline:18px;
  bottom:56px;
  z-index:2;
  color:#fff;
  text-shadow:0 10px 30px rgba(0,0,0,.45);
  max-width:min(720px, 92%);
}
.cap-title{
  font-weight:1000;
  font-size:32px;
  line-height:1.12;
  margin:0 0 6px;
}
.cap-sub{
  font-weight:800;
  font-size:16px;
  opacity:.92;
}
@media (max-width:720px){
  .cap-title{font-size:22px}
  .cap-sub{font-size:14px}
  .slide-caption{bottom:52px}
}



/* تحسين عرض صور المنتجات على الهاتف */
@media (max-width: 640px){
  .p-img{height:240px;}
}


/* Admin-only hints */
.admin-only{display:none}
body.is-admin .admin-only{display:block}

/* Slider: show full image on mobile (no cropping) */
@media (max-width:720px){
  .hero-slider img{object-fit:contain; background:#000;}
}

/* ===== UX/UI improvements ===== */
.mobile-only{display:none}
@media (max-width:720px){
  .mobile-only{display:inline-flex}
  .actions{gap:8px}
  .btn{padding:10px 12px}
}
/* Mobile drawer */
.drawer-backdrop{display:none; position:fixed; inset:0; z-index:70; background:rgba(2,8,23,.55)}
.drawer{position:fixed; top:0; inset-inline-start:0; height:100%; width:min(320px,86vw); background:#fff; z-index:71;
  border-inline-end:1px solid var(--line); box-shadow: var(--shadow); transform:translateX(110%); transition:transform .22s ease;
  padding:14px; display:flex; flex-direction:column; gap:10px}
html[dir="ltr"] .drawer{transform:translateX(-110%); inset-inline-start:auto; inset-inline-end:0; border-inline-end:0; border-inline-start:1px solid var(--line)}
.drawer.open{transform:translateX(0)}
.drawer a{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-radius:14px; text-decoration:none; font-weight:900; border:1px solid var(--line)}
.drawer a:hover{background:rgba(2,8,23,.03)}
.drawer .drawer-head{display:flex; align-items:center; justify-content:space-between; gap:10px}
.drawer .drawer-head b{font-weight:1000}
.drawer .drawer-close{border:0; background:transparent; font-size:22px; cursor:pointer}
.drawer .drawer-actions{display:grid; gap:10px; margin-top:auto}
.drawer-backdrop.show{display:block}

/* Loading indicator */
.loader{display:none; align-items:center; justify-content:center; gap:10px; padding:14px; font-weight:900; color:var(--muted)}
.loader.show{display:flex}
.spin{width:18px;height:18px;border-radius:999px;border:3px solid rgba(22,119,255,.25); border-top-color: var(--primary); animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Hover + motion */
.card, .btn, .chip, .iconbtn, .item, .p-img{transition:transform .18s ease, box-shadow .18s ease, filter .18s ease, background .18s ease}
.card:hover{transform:translateY(-2px); box-shadow:0 16px 46px rgba(2,8,23,.10)}
.btn:hover{transform:translateY(-1px)}
.iconbtn:hover{transform:translateY(-2px); filter:brightness(1.05)}

/* Small phones */
@media (max-width:380px){
  .hero h1{font-size:24px}
  .cap-title{font-size:18px}
  .p-img{height:210px}
  .pill{display:none}
}

/* Products toolbar */
.toolbar{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-top:10px}
.toolbar .left{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
.toolbar .right{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
.select{padding:10px 12px; border-radius:14px; border:1px solid var(--line); background:#fff; font-weight:900}
.input{padding:10px 12px; border-radius:14px; border:1px solid var(--line); background:#fff; font-weight:900; min-width:220px}
@media (max-width:720px){ .input{min-width:180px} }

/* Rating */
.stars{display:inline-flex; gap:6px; align-items:center}
.star{border:0; background:transparent; cursor:pointer; padding:2px; font-size:18px; color:#cbd5e1}
.star.on{color:#f59e0b}
.rating-meta{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:6px}
.badge-mini{font-weight:900; font-size:12px; padding:5px 10px; border-radius:999px; border:1px solid var(--line); background:#fff; color:var(--muted)}

/* 404 minimal */
</style>
<script type="application/ld+json" id="structuredData">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "XCharger",
    "url": "./",
    "address": {
      "@type": "PostalAddress",
      "addressLocality": "Amman",
      "addressCountry": "JO"
    }
  }
  </script>
</head>

<body>
<header>
  <div class="container">
    <div class="nav">
      <a class="brand" href="#home"><img id="brandIcon" class="brand-icon" alt="logo"> <span id="brandText">XCharger</span></a>
      <nav class="menu">
        <a href="#home" data-i18n="nav_home">الرئيسية</a>
        <a href="#products" data-i18n="nav_products">المنتجات</a>
        <a href="#compare" data-i18n="nav_compare">المقارنة</a>
        <a href="#faq" data-i18n="nav_faq">الأسئلة</a>
        <a href="#contact" data-i18n="nav_contact">اتصل بنا</a>
      </nav>
      <div class="actions">
        <button class="btn btn-ghost mobile-only" id="hamburgerBtn" aria-label="menu"><i class="fa-solid fa-bars"></i></button>
        <div class="pill" id="userPill" style="display:none"><i class="fa-solid fa-user"></i> <span id="userText"></span></div>
        <button class="chip active" id="langAR">AR</button>
        <button class="chip" id="langEN">EN</button>
        <button class="btn btn-ghost" id="adminNavBtn" style="display:none"><i class="fa-solid fa-screwdriver-wrench"></i> <span data-i18n="admin_nav">لوحة الإدارة</span></button>
        <button class="btn btn-primary" id="loginBtn"><i class="fa-solid fa-right-to-bracket"></i> <span data-i18n="login_btn">تسجيل الدخول</span></button>
        <button class="btn btn-ghost" id="logoutBtn" style="display:none"><i class="fa-solid fa-arrow-right-from-bracket"></i> <span data-i18n="logout_btn">تسجيل خروج</span></button>
        <button class="btn btn-ghost" id="cartBtn"><i class="fa-solid fa-basket-shopping"></i> <span data-i18n="cart_btn">السلة</span> <span class="cart-count" id="cartCount">0</span></button>
      </div>
    </div>
  </div>
</header>

<div class="drawer-backdrop" id="drawerBackdrop" aria-hidden="true"></div>
<aside class="drawer" id="mobileDrawer" aria-hidden="true">
  <div class="drawer-head">
    <b id="drawerBrand">XCharger</b>
    <button class="drawer-close" id="drawerClose" aria-label="close">×</button>
  </div>
  <a href="#home"><span data-i18n="nav_home">الرئيسية</span> <i class="fa-solid fa-chevron-left"></i></a>
  <a href="#products"><span data-i18n="nav_products">المنتجات</span> <i class="fa-solid fa-chevron-left"></i></a>
  <a href="#compare"><span data-i18n="nav_compare">المقارنة</span> <i class="fa-solid fa-chevron-left"></i></a>
  <a href="#faq"><span data-i18n="nav_faq">الأسئلة</span> <i class="fa-solid fa-chevron-left"></i></a>
  <a href="#contact"><span data-i18n="nav_contact">اتصل بنا</span> <i class="fa-solid fa-chevron-left"></i></a>
  <div class="drawer-actions">
    <button class="btn btn-primary" id="drawerLoginBtn"><i class="fa-solid fa-right-to-bracket"></i> <span data-i18n="login_btn">تسجيل الدخول</span></button>
    <button class="btn btn-ghost" id="drawerCartBtn"><i class="fa-solid fa-basket-shopping"></i> <span data-i18n="cart_btn">السلة</span> <span class="cart-count" id="drawerCartCount">0</span></button>
  </div>
</aside>


<main class="hero" id="home">
  <div class="container hero-wrap">
    <div class="hero-slider" id="heroSlider">
    <a class="slide" id="slideLink" href="#" aria-label="slide link">
      <img id="slideImg" alt="slide" />
      <div class="slide-caption">
        <div class="cap-title" id="slideCaptionTitle"></div>
        <div class="cap-sub" id="slideCaptionSub"></div>
      </div>
    </a>

    <div class="dots" id="slideDots" aria-label="slider dots"></div>
  </div>

  <div class="hero-inner">
      <h1 data-i18n="hero_title">طاقة المستقبل بين يديك</h1>
      <p data-i18n="hero_sub">نصمم وننتج شواحن ذكية تجمع بين الأمان وسهولة الاستخدام مع إصدارات متعددة تناسب احتياجاتك.</p>
      <div class="hero-cta">
        <a class="btn btn-primary" href="#products"><i class="fa-solid fa-bolt"></i> <span data-i18n="hero_cta1">اكتشف منتجاتنا</span></a>
        <a class="btn btn-ghost" href="#contact"><i class="fa-solid fa-paper-plane"></i> <span data-i18n="hero_cta2">طلب خاص</span></a>
      </div>
    </div>
  </div>
  </div>

  <div class="container stats">
    <div class="stats-grid" id="highlightsGrid"></div>
  </div>
</main>

<section id="products">
  <div class="container">
    <div class="title">
      <h2 data-i18n="products_title">إصدارات XCharger المتطورة</h2>
      <p class="admin-only" data-i18n="products_sub">تظهر المنتجات تلقائيًا من Firebase Firestore</p>
    </div>
    <div class="toolbar card" style="padding:12px; margin-top:14px">
      <div class="left">
        <select class="select" id="categoryFilter" aria-label="category">
          <option value="all">كل الفئات</option>
        </select>
        <input class="input" id="productSearch" type="search" placeholder="بحث في المنتجات..." aria-label="product search">
      </div>
      <div class="right">
        <button class="btn btn-ghost" id="clearFilters"><i class="fa-solid fa-broom"></i> مسح</button>
      </div>
    </div>
    <div class="loader" id="productsLoader"><span class="spin"></span><span id="productsLoaderText">جاري تحميل المنتجات...</span></div>
    <div class="products" id="productsGrid"></div>
    <div class="card" style="padding:14px; margin-top:14px;">
      <div class="muted" id="productsEmpty" data-i18n="products_empty" style="text-align:center">لا يوجد منتجات بعد. سيتم عرضها هنا عند إضافتها من لوحة الإدارة.</div>
    </div>
  </div>
</section>

<section id="compare">
  <div class="container">
    <div class="title">
      <h2 data-i18n="compare_title">مقارنة الإصدارات</h2>
      <p data-i18n="compare_sub">جدول يوضح أهم الفروقات بين الإصدارات</p>
      <div style="margin-top:12px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap">
        <button class="btn btn-ghost" id="exportComparePDF"><i class="fa-regular fa-file-pdf"></i> تصدير PDF</button>
      </div>
    </div>
    <div class="card table-wrap">
      <table id="compareTable"></table>
    </div>
  </div>
</section>

<section id="adminPanel">
  <div class="container">
    <div class="title">
      <h2><i class="fa-solid fa-screwdriver-wrench"></i> <span data-i18n="admin_title">لوحة تحكم المدير</span></h2>
      <p data-i18n="admin_sub">إضافة/تعديل/حذف المنتجات مباشرة على Firestore</p>
    </div>

    <div class="admin-grid">
      <div class="card admin-card">
        <h3 style="margin:0 0 12px; font-weight:900" data-i18n="admin_form_title">بيانات المنتج</h3>
        <div class="muted" style="margin-bottom:12px" data-i18n="admin_form_hint">املأ الحقول ثم اضغط حفظ.</div>

        <div class="field"><label data-i18n="f_name">اسم المنتج</label><input id="f_name" placeholder="xcharger" /></div>
        <div class="field"><label>الفئة (Category)</label><input id="f_category" placeholder="مثال: EVSE / Accessories" /></div>

        <div class="grid-2">
          <div class="field"><label data-i18n="f_price_jod_retail">سعر المفرق (JOD)</label><input id="f_price_jod_retail" type="number" min="0" step="0.01" placeholder="90" /></div>
          <div class="field"><label data-i18n="f_price_jod_trade">سعر التاجر (JOD)</label><input id="f_price_jod_trade" type="number" min="0" step="0.01" placeholder="80" /></div>
        </div>

        <div class="grid-2">
          <div class="field"><label data-i18n="f_price_usd_retail">سعر المفرق (USD)</label><input id="f_price_usd_retail" type="number" min="0" step="0.01" placeholder="130" /></div>
          <div class="field"><label data-i18n="f_price_usd_trade">سعر التاجر (USD)</label><input id="f_price_usd_trade" type="number" min="0" step="0.01" placeholder="110" /></div>
        </div>


        <div class="grid-2">
          <div class="field"><label>السعر قبل الخصم (JOD)</label><input id="f_old_price_jod_retail" type="number" min="0" step="0.01" placeholder="120" /></div>
          <div class="field"><label>السعر قبل الخصم (USD)</label><input id="f_old_price_usd_retail" type="number" min="0" step="0.01" placeholder="160" /></div>
        </div>

        <div class="field"><label>نسبة الخصم (اختياري %)</label><input id="f_discount_percent" type="number" min="0" max="95" step="1" placeholder="10" /></div>

        <div class="field"><label data-i18n="f_badge">وسم المنتج</label>
          <select id="f_badge">
            <option value="new" data-i18n="badge_new">جديد</option>
            <option value="best" data-i18n="badge_best">الأكثر مبيعاً</option>
            <option value="pro" data-i18n="badge_pro">احترافي</option>
          </select>
        </div>

        <div class="grid-2">
          <div class="field"><label data-i18n="f_img">رابط الصورة</label><input id="f_img" placeholder="https://..." /></div>
          <div class="field"><label data-i18n="f_video">رابط الفيديو (YouTube Embed)</label><input id="f_video" placeholder="https://www.youtube.com/embed/..." /></div>
        </div>

        <div class="grid-2">
          <div class="field"><label data-i18n="f_software">رابط السوفت وير</label><input id="f_software" placeholder="https://..." /></div>
          <div class="field"><label data-i18n="f_catalog">رابط الكاتالوج</label><input id="f_catalog" placeholder="https://..." /></div>
        </div>

        <div class="field"><label data-i18n="f_features">المواصفات (كل سطر ميزة)</label><textarea id="f_features" placeholder="شحن سريع 7kW&#10;IP65&#10;حماية متعددة"></textarea></div>

        <div class="field"><label>مواصفات إضافية (سطر لكل مواصفة)</label><textarea id="f_specs" rows="4" placeholder="مثال:&#10;التيار: 32A&#10;الجهد: 220V&#10;الكفالة: سنة"></textarea></div>


        
        <hr style="border:0;border-top:1px solid var(--line);margin:14px 0">
        <h4 style="margin:0 0 10px; font-weight:900">ميزات المقارنة لهذا المنتج</h4>

        <div class="grid-2">
          <div class="field"><label>قدرة الشحن (power)</label><input id="c_power" placeholder="7 kW" /></div>
          <div class="field"><label>الحماية (protection)</label><input id="c_protection" placeholder="IP65" /></div>
        </div>

        <div class="grid-2">
          <label style="display:flex;gap:10px;align-items:center;font-weight:900"><input type="checkbox" id="c_interface"> واجهة (interface)</label>
          <label style="display:flex;gap:10px;align-items:center;font-weight:900"><input type="checkbox" id="c_schedule"> جدولة (schedule)</label>
        </div>
        <div class="grid-2">
          <label style="display:flex;gap:10px;align-items:center;font-weight:900"><input type="checkbox" id="c_remote"> ريموت (remote)</label>
          <label style="display:flex;gap:10px;align-items:center;font-weight:900"><input type="checkbox" id="c_voice"> صوت (voice)</label>
        </div>

        <div class="grid-2">
          <button class="btn btn-primary" id="saveBtn"><i class="fa-solid fa-floppy-disk"></i> <span data-i18n="admin_save">حفظ</span></button>
          <button class="btn btn-ghost" id="clearBtn"><i class="fa-solid fa-rotate"></i> <span data-i18n="admin_clear">تفريغ النموذج</span></button>
        </div>

        <div id="adminMsg" class="hint"></div>
      </div>

      <div class="card admin-card">
        <h3 style="margin:0 0 12px; font-weight:900" data-i18n="admin_list_title">المنتجات الحالية</h3>
        <div class="muted" style="margin-bottom:12px" data-i18n="admin_list_hint">اضغط تعديل لتحميل المنتج في النموذج.</div>
        <div class="admin-list" id="adminList"></div>
      </div>

      <div class="card admin-card">
        <h3 style="margin:0 0 12px; font-weight:900">إعدادات الموقع</h3>
        <div class="muted" style="margin-bottom:12px">هذه الإعدادات تتحكم بصورة الصفحة، السلايدر، وروابط التواصل والاتصال.</div>

        <div class="field"><label>اسم العلامة (Brand)</label><input id="s_brandText" placeholder="XCharger" /></div>
        <div class="field"><label>أيقونة العلامة (Brand Icon URL)</label><input id="s_brandIcon" placeholder="https://...png" /></div>
        <div class="field"><label>صورة الصفحة (Hero Image URL)</label><input id="s_heroImage" placeholder="https://..." /></div>

        <div class="grid-2">
          <div class="field"><label>هاتف</label><input id="s_phone" placeholder="079..." /></div>
          <div class="field"><label>الإيميل الرسمي</label><input id="s_email" placeholder="info@..." /></div>
        </div>

        <div class="grid-2">
          <div class="field"><label>Facebook</label><input id="s_facebook" placeholder="https://..." /></div>
          <div class="field"><label>Instagram</label><input id="s_instagram" placeholder="https://..." /></div>
        </div>

        <div class="grid-2">
          <div class="field"><label>WhatsApp</label><input id="s_whatsapp" placeholder="https://wa.me/..." /></div>
          <div class="field"><label>Map</label><input id="s_map" placeholder="https://maps.google.com/?q=..." /></div>
        </div>

        <hr style="border:0;border-top:1px solid var(--line);margin:14px 0">

        <h4 style="margin:0 0 10px; font-weight:900">سلايدر (4 صور)</h4>
        <div class="grid-2">
          <div class="field"><label>Slide 1 Image</label><input id="s_sl1_img" placeholder="https://..." /></div>
          <div class="field"><label>Slide 1 Link</label><input id="s_sl1_link" placeholder="#products أو https://..." /></div>
        </div>
  <div class="grid-2">
    <div class="field"><label>Slide 1 Caption (AR)</label><input id="s_sl1_cap_ar" placeholder="..." /></div>
    <div class="field"><label>Slide 1 Caption (EN)</label><input id="s_sl1_cap_en" placeholder="..." /></div>
  </div>

        <div class="grid-2">
          <div class="field"><label>Slide 2 Image</label><input id="s_sl2_img" placeholder="https://..." /></div>
          <div class="field"><label>Slide 2 Link</label><input id="s_sl2_link" placeholder="#compare أو https://..." /></div>
        </div>
  <div class="grid-2">
    <div class="field"><label>Slide 2 Caption (AR)</label><input id="s_sl2_cap_ar" placeholder="..." /></div>
    <div class="field"><label>Slide 2 Caption (EN)</label><input id="s_sl2_cap_en" placeholder="..." /></div>
  </div>

        <div class="grid-2">
          <div class="field"><label>Slide 3 Image</label><input id="s_sl3_img" placeholder="https://..." /></div>
          <div class="field"><label>Slide 3 Link</label><input id="s_sl3_link" placeholder="#faq أو https://..." /></div>
        </div>
  <div class="grid-2">
    <div class="field"><label>Slide 3 Caption (AR)</label><input id="s_sl3_cap_ar" placeholder="..." /></div>
    <div class="field"><label>Slide 3 Caption (EN)</label><input id="s_sl3_cap_en" placeholder="..." /></div>
  </div>

        <div class="grid-2">
          <div class="field"><label>Slide 4 Image</label><input id="s_sl4_img" placeholder="https://..." /></div>
          <div class="field"><label>Slide 4 Link</label><input id="s_sl4_link" placeholder="#contact أو https://..." /></div>
        </div>
  <div class="grid-2">
    <div class="field"><label>Slide 4 Caption (AR)</label><input id="s_sl4_cap_ar" placeholder="..." /></div>
    <div class="field"><label>Slide 4 Caption (EN)</label><input id="s_sl4_cap_en" placeholder="..." /></div>
  </div>


        <hr style="border:0;border-top:1px solid var(--line);margin:14px 0">

        <h4 style="margin:0 0 10px; font-weight:900">بطاقات المزايا (4 بطاقات)</h4>
        <div class="muted" style="margin-bottom:10px">عدّل النصوص والأيقونات التي تظهر تحت السلايدر.</div>

        <!-- Highlight 1 -->
        <div class="grid-2">
          <div class="field"><label>Card 1 Icon (FontAwesome)</label><input id="h1_icon" placeholder="fa-solid fa-sliders" /></div>
          <div class="field"><label>Card 1 Key (AR)</label><input id="h1_k_ar" placeholder="تحكم ذكي مرن" /></div>
        </div>
        <div class="grid-2">
          <div class="field"><label>Card 1 Value (AR)</label><input id="h1_v_ar" placeholder="تجربة استخدام سهلة" /></div>
          <div class="field"><label>Card 1 Key (EN)</label><input id="h1_k_en" placeholder="Smart control" /></div>
        </div>
        <div class="grid-2">
          <div class="field"><label>Card 1 Value (EN)</label><input id="h1_v_en" placeholder="Easy experience" /></div>
          <div class="field"><label>&nbsp;</label><div class="hint">مثال للأيقونة: fa-solid fa-shield-halved</div></div>
        </div>

        <!-- Highlight 2 -->
        <div class="grid-2">
          <div class="field"><label>Card 2 Icon</label><input id="h2_icon" placeholder="fa-solid fa-shield-halved" /></div>
          <div class="field"><label>Card 2 Key (AR)</label><input id="h2_k_ar" placeholder="100%" /></div>
        </div>
        <div class="grid-2">
          <div class="field"><label>Card 2 Value (AR)</label><input id="h2_v_ar" placeholder="أمان واعتمادية" /></div>
          <div class="field"><label>Card 2 Key (EN)</label><input id="h2_k_en" placeholder="100%" /></div>
        </div>
        <div class="grid-2">
          <div class="field"><label>Card 2 Value (EN)</label><input id="h2_v_en" placeholder="Safety & reliability" /></div>
          <div class="field"><label>&nbsp;</label></div>
        </div>

        <!-- Highlight 3 -->
        <div class="grid-2">
          <div class="field"><label>Card 3 Icon</label><input id="h3_icon" placeholder="fa-solid fa-headset" /></div>
          <div class="field"><label>Card 3 Key (AR)</label><input id="h3_k_ar" placeholder="24/7" /></div>
        </div>
        <div class="grid-2">
          <div class="field"><label>Card 3 Value (AR)</label><input id="h3_v_ar" placeholder="دعم فني" /></div>
          <div class="field"><label>Card 3 Key (EN)</label><input id="h3_k_en" placeholder="24/7" /></div>
        </div>
        <div class="grid-2">
          <div class="field"><label>Card 3 Value (EN)</label><input id="h3_v_en" placeholder="Support" /></div>
          <div class="field"><label>&nbsp;</label></div>
        </div>

        <!-- Highlight 4 -->
        <div class="grid-2">
          <div class="field"><label>Card 4 Icon</label><input id="h4_icon" placeholder="fa-solid fa-medal" /></div>
          <div class="field"><label>Card 4 Key (AR)</label><input id="h4_k_ar" placeholder="3" /></div>
        </div>
        <div class="grid-2">
          <div class="field"><label>Card 4 Value (AR)</label><input id="h4_v_ar" placeholder="ضمان" /></div>
          <div class="field"><label>Card 4 Key (EN)</label><input id="h4_k_en" placeholder="3" /></div>
        </div>
        <div class="grid-2">
          <div class="field"><label>Card 4 Value (EN)</label><input id="h4_v_en" placeholder="Warranty" /></div>
          <div class="field"><label>&nbsp;</label></div>
        </div>


        <div class="grid-2">
          <button class="btn btn-primary" id="saveSiteBtn"><i class="fa-solid fa-floppy-disk"></i> حفظ الإعدادات</button>
          <button class="btn btn-ghost" id="resetSiteBtn"><i class="fa-solid fa-rotate"></i> إعادة تحميل</button>
        </div>

        <div id="siteMsg" class="hint"></div>
      </div>

      <div class="card admin-card">
        <h3 style="margin:0 0 12px; font-weight:900">إدارة الأسئلة الشائعة (FAQ)</h3>

        <div class="grid-2">
          <div class="field"><label>السؤال (AR)</label><input id="f_faq_q_ar" placeholder="..." /></div>
          <div class="field"><label>السؤال (EN)</label><input id="f_faq_q_en" placeholder="..." /></div>
        </div>

        <div class="grid-2">
          <div class="field"><label>الجواب (AR)</label><textarea id="f_faq_a_ar" placeholder="..."></textarea></div>
          <div class="field"><label>الجواب (EN)</label><textarea id="f_faq_a_en" placeholder="..."></textarea></div>
        </div>

        <div class="grid-2">
          <div class="field"><label>الترتيب (Order)</label><input id="f_faq_order" type="number" min="0" step="1" value="1" /></div>
          <div class="field"><label>&nbsp;</label>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn btn-primary" id="saveFaqBtn"><i class="fa-solid fa-floppy-disk"></i> حفظ</button>
              <button class="btn btn-ghost" id="clearFaqBtn"><i class="fa-solid fa-rotate"></i> تفريغ</button>
            </div>
          </div>
        </div>

        <div id="faqMsg" class="hint"></div>
        <div class="admin-list" id="faqAdminList" style="margin-top:12px"></div>
      </div>
    </div>
  </div>
</section>

<section id="faq">
  <div class="container">
    <div class="title">
      <h2 data-i18n="faq_title">الأسئلة الشائعة</h2>
      <p data-i18n="faq_sub">إجابات مختصرة قبل الشراء</p>
    </div>
    <div class="card" style="padding:12px; margin-bottom:12px">
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input class="input" id="faqSearch" type="search" placeholder="بحث داخل الأسئلة..." aria-label="faq search" style="flex:1; min-width:220px">
      </div>
    </div>
    <div class="grid-2" id="faqGrid"></div>
  </div>
</section>

<footer id="contact">
  <div class="container">
    <div class="foot">
      <div>
        <h3>XCharger</h3>
        <p class="muted" style="color:#cbd5e1" data-i18n="foot_about">حلول شحن للمركبات الكهربائية مصممة في الأردن بجودة واعتمادية.</p>
        <div class="social" style="margin-top:12px">
          <a class="iconbtn" id="socialFacebook" href="#" target="_blank" rel="noopener" aria-label="facebook"><i class="fa-brands fa-facebook-f"></i></a>
          <a class="iconbtn" id="socialInstagram" href="#" target="_blank" rel="noopener" aria-label="instagram"><i class="fa-brands fa-instagram"></i></a>
          <a class="iconbtn" id="socialWhatsapp" href="#" target="_blank" rel="noopener" aria-label="whatsapp"><i class="fa-brands fa-whatsapp"></i></a>
          <a class="iconbtn" id="socialPhone" href="#" aria-label="phone"><i class="fa-solid fa-phone"></i></a>
          <a class="iconbtn" id="socialMap" href="#" target="_blank" rel="noopener" aria-label="map"><i class="fa-solid fa-location-dot"></i></a>
        </div>
      </div>

      <div>
        <h4 data-i18n="foot_links">روابط</h4>
        <p><a href="#products" style="text-decoration:none;color:#cbd5e1" data-i18n="nav_products">المنتجات</a></p>
        <p><a href="#compare" style="text-decoration:none;color:#cbd5e1" data-i18n="nav_compare">المقارنة</a></p>
        <p><a href="#faq" style="text-decoration:none;color:#cbd5e1" data-i18n="nav_faq">الأسئلة</a></p>
      </div>

      <div>
        <h4 data-i18n="foot_contact">تواصل معنا</h4>
        <p><i class="fa-solid fa-location-dot"></i> <span data-i18n="foot_addr">عمّان - الأردن</span></p>
        <p><i class="fa-solid fa-phone"></i> <span id="footPhoneText">0790781206</span></p>
        <p><i class="fa-solid fa-envelope"></i> <a id="footEmailLink" href="mailto:info@xcharger.com" style="color:#cbd5e1;text-decoration:none">info@xcharger.com</a></p>
      </div>
    </div>

    <div class="copy">© <span id="year"></span> XCharger</div>
  </div>
</footer>

<div class="modal" id="loginModal" aria-hidden="true">
  <div class="modal-inner">
    <div class="modal-head">
      <h3 data-i18n="login_title">تسجيل الدخول</h3>
      <button class="x" id="closeModal" aria-label="close">×</button>
    </div>

    <div class="field" style="margin-top:10px">
      <label data-i18n="login_email">البريد الإلكتروني</label>
      <input id="loginEmail" type="email" placeholder="example@domain.com">
    </div>

    <div class="field">
      <label data-i18n="login_pass">كلمة المرور</label>
      <input id="loginPass" type="password" placeholder="********">
    </div>

    <button class="btn btn-primary" id="doLogin" style="width:100%; justify-content:center"><i class="fa-solid fa-lock"></i> <span data-i18n="login_do">دخول</span></button>
    <div id="loginMsg" class="hint"></div>
    <div id="roleHint" class="hint" data-i18n="role_hint">أنت مسجّل دخول لكن دورك ليس Admin. اجعل role="admin" داخل Firestore → users/{uid}.</div>
  </div>
</div>


<div class="modal" id="cartModal" aria-hidden="true">
  <div class="modal-inner wide">
    <div class="modal-head">
      <h3 data-i18n="cart_title">سلة المشتريات</h3>
      <button class="x" id="closeCart" aria-label="close">×</button>
    </div>

    <div id="cartBody" style="margin-top:12px; display:grid; gap:10px"></div>

    <div class="cart-total" style="margin-top:12px; display:grid; gap:6px">
      <div style="display:flex; justify-content:space-between; gap:10px"><div data-i18n="cart_total">الإجمالي</div><div id="cartSubTotalVal">0</div></div>
      <div style="display:flex; justify-content:space-between; gap:10px"><div id="cartDiscountLabel">الخصم</div><div id="cartDiscountVal">0</div></div>
      <div style="display:flex; justify-content:space-between; gap:10px"><div id="cartAfterLabel">الإجمالي بعد الخصم</div><div id="cartTotalVal">0</div></div>
    </div>

    <div class="card" style="padding:12px; margin-top:12px">
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
        <div style="font-weight:1000"><i class="fa-solid fa-tag"></i> كود خصم</div>
        <input class="input" id="couponInput" placeholder="مثال: SAVE10" style="flex:1; min-width:180px" autocomplete="off">
        <button class="btn btn-ghost" id="applyCoupon"><i class="fa-solid fa-check"></i> تطبيق</button>
      </div>
      <div class="muted" id="couponHint" style="margin-top:8px; display:none"></div>
    </div>

    <div class="cart-note" style="margin-top:8px" data-i18n="cart_note">الأسعار حسب العملة الظاهرة وقت الإضافة. يمكنك تعديل الكميات قبل الإرسال.</div>

    <hr style="border:none; border-top:1px solid var(--line); margin:14px 0">

    <h4 style="margin:0 0 8px; font-weight:900" data-i18n="checkout_title">بيانات الطلب</h4>

    <div class="grid-2">
      <div class="field"><label data-i18n="co_name">الاسم</label><input id="co_name" placeholder="الاسم الكامل" /></div>
      <div class="field"><label data-i18n="co_phone">رقم الهاتف</label><input id="co_phone" placeholder="07xxxxxxxx" /></div>
    </div>
    <div class="grid-2">
      <div class="field"><label data-i18n="co_city">المدينة</label><input id="co_city" placeholder="عمّان" /></div>
      <div class="field"><label data-i18n="co_address">العنوان</label><input id="co_address" placeholder="الحي / الشارع / رقم" /></div>
    </div>
    <div class="field"><label data-i18n="co_note">ملاحظات</label><textarea id="co_note" placeholder=""></textarea></div>

    <button class="btn btn-primary" id="placeOrder" style="width:100%; justify-content:center"><i class="fa-solid fa-paper-plane"></i> <span data-i18n="cart_place">إرسال الطلب</span></button>
    <div id="cartMsg" class="hint"></div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js" crossorigin="anonymous"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { getFirestore, collection, addDoc, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {'apiKey': 'AIzaSyAK4E04TdC_OERPQmvxlKFs_qFSmVwMuiI', 'authDomain': 'xcharger-5bb95.firebaseapp.com', 'projectId': 'xcharger-5bb95', 'storageBucket': 'xcharger-5bb95.firebasestorage.app', 'messagingSenderId': '570288654795', 'appId': '1:570288654795:web:94ecb2b696a0da7f408e4e', 'measurementId': 'G-Q9ZX3HYVQV'};

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  try { await setPersistence(auth, browserLocalPersistence); } catch(e) {}

  let LANG = "ar";
  let ROLE = "retail";
  let USER = null;
  let PRODUCTS = [];
  let EDITING_ID = null;
  let CART = [];
  const CART_KEY = "xcharger_cart_v1";

const SETTINGS_KEY = "xcharger_settings_v1";
  const ORDER_RATE_KEY = "xcharger_order_rate_v1";
  const RATE_RATE_KEY = "xcharger_rating_rate_v1";
  const ABANDON_KEY = "xcharger_abandoned_sent_v1";
  const CLIENT_ID_KEY = "xcharger_client_id_v1";

  const state = {
    productsLoading: true,
    category: "all",
    q: "",
    faqQ: "",
    coupon: null, // {code,type,value,amountOff}
  };

  function getClientId(){
    let id = localStorage.getItem(CLIENT_ID_KEY);
    if (!id){
      id = (crypto?.randomUUID ? crypto.randomUUID() : (Date.now().toString(36)+Math.random().toString(36).slice(2)));
      localStorage.setItem(CLIENT_ID_KEY, id);
    }
    return id;
  }

  // Simple event bus (organized events)
  const Bus = (() => {
    const map = new Map();
    return {
      on(evt, fn){ if(!map.has(evt)) map.set(evt,new Set()); map.get(evt).add(fn); return ()=>map.get(evt)?.delete(fn); },
      emit(evt, payload){ map.get(evt)?.forEach(fn=>{ try{ fn(payload); } catch(e){ console.warn("bus handler error", evt, e); } }); }
    };
  })();

  function loadUiSettings(){
    try{
      const s = JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}");
      if (s.lang === "ar" || s.lang === "en") LANG = s.lang;
      if (typeof s.category === "string") state.category = s.category;
      if (typeof s.q === "string") state.q = s.q;
      if (typeof s.faqQ === "string") state.faqQ = s.faqQ;
      if (s.coupon && typeof s.coupon === "object") state.coupon = s.coupon;
    }catch(e){}
  }
  function saveUiSettings(){
    localStorage.setItem(SETTINGS_KEY, JSON.stringify({ lang: LANG, category: state.category, q: state.q, faqQ: state.faqQ, coupon: state.coupon }));
  }


  const $ = (id)=>document.getElementById(id);

  const i18n = {
    ar: {
      nav_home:"الرئيسية", nav_products:"المنتجات", nav_compare:"المقارنة", nav_faq:"الأسئلة", nav_contact:"اتصل بنا",
      login_btn:"تسجيل الدخول", logout_btn:"تسجيل خروج", admin_nav:"لوحة الإدارة", cart_btn:"السلة", cart_title:"سلة المشتريات", cart_total:"الإجمالي", cart_note:"الأسعار حسب العملة الظاهرة وقت الإضافة. يمكنك تعديل الكميات قبل الإرسال.", checkout_title:"بيانات الطلب", co_name:"الاسم", co_phone:"رقم الهاتف", co_city:"المدينة", co_address:"العنوان", co_note:"ملاحظات", cart_place:"إرسال الطلب", cart_empty:"سلتك فارغة.", cart_added:"تمت الإضافة إلى السلة ✅", cart_saved:"تم إرسال الطلب بنجاح ✅", cart_failed:"فشل إرسال الطلب", cart_remove:"حذف",
      hero_title:"طاقة المستقبل بين يديك", hero_sub:"نصمم وننتج شواحن ذكية تجمع بين الأمان وسهولة الاستخدام مع إصدارات متعددة تناسب احتياجاتك.",
      hero_cta1:"اكتشف منتجاتنا", hero_cta2:"طلب خاص",
      stat_1:"ضمان", stat_2:"دعم فني", stat_3:"أمان واعتمادية", stat_4_title:"تحكم ذكي مرن", stat_4:"تجربة استخدام سهلة",
      products_title:"إصدارات XCharger المتطورة", products_sub:"تظهر المنتجات تلقائيًا من Firebase Firestore",
      products_empty:"لا يوجد منتجات بعد. سيتم عرضها هنا عند إضافتها من لوحة الإدارة.",
      compare_title:"مقارنة الإصدارات", compare_sub:"جدول يوضح أهم الفروقات بين الإصدارات",
      admin_title:"لوحة تحكم المدير", admin_sub:"إضافة/تعديل/حذف المنتجات مباشرة على Firestore",
      admin_form_title:"بيانات المنتج", admin_form_hint:"املأ الحقول ثم اضغط حفظ.",
      admin_save:"حفظ", admin_clear:"تفريغ النموذج", admin_list_title:"المنتجات الحالية", admin_list_hint:"اضغط تعديل لتحميل المنتج في النموذج.",
      f_name:"اسم المنتج", f_price_jod_retail:"سعر المفرق (JOD)", f_price_jod_trade:"سعر التاجر (JOD)", f_price_usd_retail:"سعر المفرق (USD)", f_price_usd_trade:"سعر التاجر (USD)",
      f_badge:"وسم المنتج", badge_new:"جديد", badge_best:"الأكثر مبيعاً", badge_pro:"احترافي",
      f_img:"رابط الصورة", f_video:"رابط الفيديو (YouTube Embed)", f_software:"رابط السوفت وير", f_catalog:"رابط الكاتالوج",
      f_features:"المواصفات (كل سطر ميزة)",
      faq_title:"الأسئلة الشائعة", faq_sub:"إجابات مختصرة قبل الشراء",
      faq_q1:"هل الشاحن مناسب للاستخدام اليومي؟", faq_a1:"نعم، مصمم ليعمل بثبات مع حماية متعددة ويتيح جدولة الشحن وواجهة استخدام سهلة.",
      faq_q2:"هل يدعم الشاحن الجدولة والواجهة؟", faq_a2:"نعم للجميع — الواجهة وجدولة الشحن متاحة في كل الإصدارات.",
      foot_about:"حلول شحن للمركبات الكهربائية مصممة في الأردن بجودة واعتمادية.",
      foot_links:"روابط", foot_contact:"تواصل معنا", foot_addr:"عمّان - الأردن",
      login_title:"تسجيل الدخول", login_email:"البريد الإلكتروني", login_pass:"كلمة المرور", login_do:"دخول",
      role_hint:'أنت مسجّل دخول لكن دورك ليس Admin. اجعل role="admin" داخل Firestore → users/{uid}.',
      btn_sw:"السوفت وير", btn_cat:"الكاتالوج", btn_vid:"شرح", btn_order:"اطلب الآن",
      admin_edit:"تعديل", admin_delete:"حذف", saved_ok:"تم الحفظ بنجاح ✅", deleted_ok:"تم الحذف ✅"
    },
    en: {
      nav_home:"Home", nav_products:"Products", nav_compare:"Compare", nav_faq:"FAQ", nav_contact:"Contact",
      login_btn:"Sign in", logout_btn:"Sign out", admin_nav:"Admin", cart_btn:"Cart", cart_title:"Shopping cart", cart_total:"Total", cart_note:"Prices use the currency shown when you added items. You can change quantities before sending.", checkout_title:"Order details", co_name:"Name", co_phone:"Phone", co_city:"City", co_address:"Address", co_note:"Notes", cart_place:"Place order", cart_empty:"Your cart is empty.", cart_added:"Added to cart ✅", cart_saved:"Order sent ✅", cart_failed:"Order failed", cart_remove:"Remove",
      hero_title:"Future power in your hands", hero_sub:"We design and manufacture smart EV chargers combining safety and ease of use, with multiple editions for different needs.",
      hero_cta1:"Explore products", hero_cta2:"Custom request",
      stat_1:"Warranty", stat_2:"Support", stat_3:"Safety", stat_4_title:"Flexible smart control", stat_4:"Easy experience",
      products_title:"XCharger editions", products_sub:"Products are loaded live from Firebase Firestore",
      products_empty:"No products yet. Add the first product from the Admin panel.",
      compare_title:"Compare editions", compare_sub:"Key differences at a glance",
      admin_title:"Admin Panel", admin_sub:"Create / update / delete products on Firestore",
      admin_form_title:"Product data", admin_form_hint:"Fill the fields then click Save.",
      admin_save:"Save", admin_clear:"Reset", admin_list_title:"Existing products", admin_list_hint:"Click Edit to load into the form.",
      f_name:"Product name", f_price_jod_retail:"Retail (JOD)", f_price_jod_trade:"Trade (JOD)", f_price_usd_retail:"Retail (USD)", f_price_usd_trade:"Trade (USD)",
      f_badge:"Badge", badge_new:"New", badge_best:"Best seller", badge_pro:"Pro",
      f_img:"Image URL", f_video:"Video URL (Embed)", f_software:"Software URL", f_catalog:"Catalog URL",
      f_features:"Specs (one per line)",
      faq_title:"FAQ", faq_sub:"Quick answers before buying",
      faq_q1:"Is it suitable for daily use?", faq_a1:"Yes, built for stability with multiple protections, scheduling and an easy interface.",
      faq_q2:"Does it support scheduling and interface?", faq_a2:"Yes for all editions — scheduling and interface are included.",
      foot_about:"EV charging solutions designed in Jordan with quality and reliability.",
      foot_links:"Links", foot_contact:"Contact", foot_addr:"Amman, Jordan",
      login_title:"Sign in", login_email:"Email", login_pass:"Password", login_do:"Sign in",
      role_hint:'You are signed in but not Admin. Set role="admin" in Firestore → users/{uid}.',
      btn_sw:"Software", btn_cat:"Catalog", btn_vid:"Video", btn_order:"Order",
      admin_edit:"Edit", admin_delete:"Delete", saved_ok:"Saved ✅", deleted_ok:"Deleted ✅"
    }
  };

  function applyLang() {
    document.documentElement.lang = LANG;
    document.documentElement.dir = (LANG==="ar") ? "rtl" : "ltr";
    $("langAR").classList.toggle("active", LANG==="ar");
    $("langEN").classList.toggle("active", LANG==="en");

    document.querySelectorAll("[data-i18n]").forEach(el=>{
      const k = el.getAttribute("data-i18n");
      const v = i18n[LANG][k];
      if (typeof v === "string") el.textContent = v;
    });

// extra labels not covered by data-i18n
    const d1 = $("cartDiscountLabel"); if (d1) d1.textContent = (LANG==="ar") ? "الخصم" : "Discount";
    const d2 = $("cartAfterLabel"); if (d2) d2.textContent = (LANG==="ar") ? "الإجمالي بعد الخصم" : "Total after discount";
    const cInp = $("couponInput"); if (cInp) cInp.placeholder = (LANG==="ar") ? "مثال: SAVE10" : "e.g. SAVE10";
    const pSearch = $("productSearch"); if (pSearch) pSearch.placeholder = (LANG==="ar") ? "بحث في المنتجات..." : "Search products...";
    const fSearch = $("faqSearch"); if (fSearch) fSearch.placeholder = (LANG==="ar") ? "بحث داخل الأسئلة..." : "Search FAQs...";
    saveUiSettings();
    renderCart();

    renderProducts();
    renderCompare();
  }

  function fmtPrice(p) {
    if (p === null || p === undefined || p === "") return "";
    const n = Number(p);
    if (Number.isNaN(n)) return String(p);
    return (LANG==="ar") ? (n.toFixed(0) + " د.أ") : ("$" + n.toFixed(0));
  }

  function badgeText(b) {
    const map = {
      new: (LANG==="ar" ? "جديد" : "New"),
      best: (LANG==="ar" ? "الأكثر مبيعاً" : "Best"),
      pro: (LANG==="ar" ? "احترافي" : "Pro"),
    };
    return map[b] || "";
  }

  function showHint(el, msg, ok=true) {
    if (!el) return;
    el.style.display = "block";
    el.style.color = ok ? "#166534" : "#b91c1c";
    el.textContent = msg;
    setTimeout(()=>{ el.style.display="none"; }, 2600);
  }

  function escapeHtml(s) {
    return s.replace(/[&<>"']/g, (c)=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
  }

  function safeUrl(u){
    const s = String(u||"").trim();
    if (!s) return "#";
    // block javascript: and data:
    const low = s.toLowerCase();
    if (low.startsWith("javascript:") || low.startsWith("data:")) return "#";
    return s;
  }

  // Lazy image loader (progressive)
  let __io = null;
  function lazyLoadImages(){
    const imgs = document.querySelectorAll('img[data-src]');
    if (!imgs.length) return;
    const load = (img)=>{
      const src = img.getAttribute("data-src");
      if (!src) return;
      img.src = src;
      img.removeAttribute("data-src");
    };
    if (!("IntersectionObserver" in window)){
      imgs.forEach(load); return;
    }
    if (!__io){
      __io = new IntersectionObserver((entries)=>{
        entries.forEach(ent=>{
          if(ent.isIntersecting){
            load(ent.target);
            __io.unobserve(ent.target);
          }
        });
      }, { rootMargin:"250px" });
    }
    imgs.forEach(img=>__io.observe(img));
  }

  // Simple local rate limiter (client-side)
  function rateLimit(key, opts){
    const now = Date.now();
    const windowMs = opts.windowMs || 60_000;
    const max = opts.max || 3;
    let bucket;
    try{ bucket = JSON.parse(localStorage.getItem(key) || "{}"); }catch(e){ bucket = {}; }
    const arr = Array.isArray(bucket.t) ? bucket.t.filter(ts=> now-ts < windowMs) : [];
    if (arr.length >= max) return { ok:false, retryMs: windowMs - (now - arr[0]) };
    arr.push(now);
    localStorage.setItem(key, JSON.stringify({ t: arr }));
    return { ok:true, retryMs:0 };
  }

  function isValidPhoneJO(s){
    const v = String(s||"").replace(/\s+/g,"");
    return /^\+?9627\d{8}$/.test(v) || /^07\d{8}$/.test(v);
  }


  // ===== Admin-controlled site settings + slider + FAQ =====
  let SITE = null;
  let FAQS = [];
  let EDITING_FAQ_ID = null;

  const DEFAULT_SITE = {
    brandText: "XCharger",
    brandIcon: "",
    heroImage: "https://images.unsplash.com/photo-1593941707882-a5bba14938c7?auto=format&fit=crop&w=1600&q=80",
    slider: [
      { img: "https://images.unsplash.com/photo-1497436072909-60f360e1d4b1?auto=format&fit=crop&w=1600&q=80", link:"#products",
        caption_ar: "اكتشف منتجاتنا", caption_en: "Explore our products" },
      { img: "https://images.unsplash.com/photo-1518770660439-4636190af475?auto=format&fit=crop&w=1600&q=80", link:"#compare",
        caption_ar: "قارن بين الإصدارات", caption_en: "Compare versions" },
      { img: "https://images.unsplash.com/photo-1520607162513-77705c0f0d4a?auto=format&fit=crop&w=1600&q=80", link:"#faq",
        caption_ar: "أسئلة وأجوبة قبل الشراء", caption_en: "FAQ before purchase" },
      { img: "https://images.unsplash.com/photo-1488590528505-98d2b5aba04b?auto=format&fit=crop&w=1600&q=80", link:"#contact",
        caption_ar: "تواصل معنا الآن", caption_en: "Contact us" }
    ],
    contact: { phone:"0790781206", officialEmail:"info@xcharger.com" },
    social: { facebook:"#", instagram:"#", whatsapp:"https://wa.me/962790781206", map:"https://maps.google.com/?q=Amman%2C%20Jordan" },
    compareFeatures: [
      { key:"power", ar:"قدرة الشحن", en:"Charging power", type:"text" },
      { key:"protection", ar:"الحماية", en:"Protection", type:"text" },
      { key:"interface", ar:"واجهة", en:"Interface", type:"bool" },
      { key:"schedule", ar:"جدولة الشحن", en:"Scheduling", type:"bool" },
      { key:"remote", ar:"ريموت تحكم", en:"Remote unit", type:"bool" },
      { key:"voice", ar:"أوامر صوتية", en:"Voice control", type:"bool" }
    ],
    highlights: [
      { icon:"fa-solid fa-sliders", k_ar:"تحكم ذكي مرن", v_ar:"تجربة استخدام سهلة", k_en:"Smart control", v_en:"Easy experience" },
      { icon:"fa-solid fa-shield-halved", k_ar:"100%", v_ar:"أمان واعتمادية", k_en:"100%", v_en:"Safety & reliability" },
      { icon:"fa-solid fa-headset", k_ar:"24/7", v_ar:"دعم فني", k_en:"24/7", v_en:"Support" },
      { icon:"fa-solid fa-medal", k_ar:"3", v_ar:"ضمان", k_en:"3", v_en:"Warranty" }
    ]
  };

  function safeUrl(u){ return (typeof u==="string" && u.trim()) ? u.trim() : "#"; }

  // ===== Slider =====
  let SLIDE_IDX = 0;
  let SLIDE_TIMER = null;


  function renderHighlights(){
    const grid = $("highlightsGrid");
    if (!grid) return;

    const s = SITE || DEFAULT_SITE;
    const items = Array.isArray(s.highlights) && s.highlights.length ? s.highlights.slice(0,4) : (DEFAULT_SITE.highlights||[]);

    const label = (x, aKey, eKey)=> (LANG==="ar" ? (x[aKey] ?? "") : (x[eKey] ?? ""));
    const safeIcon = (ic)=> (typeof ic==="string" && ic.includes("fa-")) ? ic.trim() : "fa-solid fa-star";

    grid.innerHTML = items.map(x=>{
      const k = escapeHtml(label(x,"k_ar","k_en") || "");
      const v = escapeHtml(label(x,"v_ar","v_en") || "");
      const icon = safeIcon(x.icon);
      return `
        <div class="stat">
          <i class="${icon}"></i>
          <div>
            <div class="k">${k}</div>
            <div class="v">${v}</div>
          </div>
        </div>
      `;
    }).join("");
  }

  function initOrUpdateSlider(){
    const s = SITE || DEFAULT_SITE;
    const slides = Array.isArray(s.slider) ? s.slider.slice(0,4) : DEFAULT_SITE.slider;

    const imgEl = $("slideImg");
    const linkEl = $("slideLink");
    const dotsEl = $("slideDots");
    if (!imgEl || !linkEl || !dotsEl) return;

    dotsEl.innerHTML = "";
    slides.forEach((_,i)=>{
      const d = document.createElement("button");
      d.className = "dot" + (i===SLIDE_IDX ? " active" : "");
      d.type="button";
      d.addEventListener("click", ()=>{ SLIDE_IDX=i; renderSlide(); restartSlider(); });
      dotsEl.appendChild(d);
    });

    function renderSlide(){
      const cur = slides[SLIDE_IDX] || slides[0];
      imgEl.src = cur.img || DEFAULT_SITE.slider[0].img;
      linkEl.href = cur.link || "#";
      [...dotsEl.children].forEach((x,j)=>x.classList.toggle("active", j===SLIDE_IDX));
    }

    function restartSlider(){
      if (SLIDE_TIMER) clearInterval(SLIDE_TIMER);
      SLIDE_TIMER = setInterval(()=>{
        SLIDE_IDX = (SLIDE_IDX + 1) % slides.length;
        renderSlide();
      }, 4500);
    }

    renderSlide();
    restartSlider();
  }

  function applySite() {
    const s = SITE || DEFAULT_SITE;

    // Brand
    const brand = $("brandText");
    if (brand) brand.textContent = s.brandText || "XCharger";
    const dbrand = $("drawerBrand");
    if (dbrand) dbrand.textContent = s.brandText || "XCharger";

    const bIcon = document.getElementById("brandIcon");
    const iconUrl = (s.brandIcon || "").trim();
    if (bIcon) {
      if (iconUrl) {
        bIcon.src = iconUrl;
        document.body.classList.add("has-brand-icon");
      } else {
        bIcon.removeAttribute("src");
        document.body.classList.remove("has-brand-icon");
      }
    }

    // Footer contact
    const phoneTxt = $("footPhoneText");
    if (phoneTxt) phoneTxt.textContent = s.contact?.phone || DEFAULT_SITE.contact.phone;

    const emailLink = $("footEmailLink");
    const em = s.contact?.officialEmail || DEFAULT_SITE.contact.officialEmail;
    if (emailLink) {
      emailLink.textContent = em;
      emailLink.href = "mailto:" + em;
    }

    // Social links
    const fb = $("socialFacebook");
    const ig = $("socialInstagram");
    const wa = $("socialWhatsapp");
    const ph = $("socialPhone");
    const mp = $("socialMap");

    if (fb) fb.href = safeUrl(s.social?.facebook);
    if (ig) ig.href = safeUrl(s.social?.instagram);
    if (wa) wa.href = safeUrl(s.social?.whatsapp);
    if (mp) mp.href = safeUrl(s.social?.map);
    if (ph) ph.href = "tel:" + (s.contact?.phone || DEFAULT_SITE.contact.phone);

    renderHighlights();
    initOrUpdateSlider();
  }

  // ===== Admin: Site settings form =====
  function fillSiteForm(){
    if (!isAdmin()) return;

    const s = SITE || DEFAULT_SITE;
    const setVal = (id,v)=>{ const el=$(id); if(el) el.value = v ?? ""; };

    setVal("s_brandText", s.brandText);
  setVal("s_brandIcon", s.brandIcon);
    setVal("s_heroImage", s.heroImage);

    setVal("s_phone", s.contact?.phone);
    setVal("s_email", s.contact?.officialEmail);

    setVal("s_facebook", s.social?.facebook);
    setVal("s_instagram", s.social?.instagram);
    setVal("s_whatsapp", s.social?.whatsapp);
    setVal("s_map", s.social?.map);

    const sl = Array.isArray(s.slider) ? s.slider : DEFAULT_SITE.slider;
    [0,1,2,3].forEach(i=>{
      setVal(`s_sl${i+1}_img`, sl[i]?.img);
      setVal(`s_sl${i+1}_link`, sl[i]?.link);
      setVal(`s_sl${i+1}_cap_ar`, sl[i]?.caption_ar);
      setVal(`s_sl${i+1}_cap_en`, sl[i]?.caption_en);
    });

    const hs = Array.isArray(s.highlights) ? s.highlights : (DEFAULT_SITE.highlights||[]);
    [0,1,2,3].forEach(i=>{
      const x = hs[i] || {};
      setVal(`h${i+1}_icon`, x.icon);
      setVal(`h${i+1}_k_ar`, x.k_ar);
      setVal(`h${i+1}_v_ar`, x.v_ar);
      setVal(`h${i+1}_k_en`, x.k_en);
      setVal(`h${i+1}_v_en`, x.v_en);
    });
  }

  function getSiteFormData(){
    const getVal = (id)=>($(id)?.value||"").trim();
    return {
      brandText: getVal("s_brandText"),
    brandIcon: getVal("s_brandIcon"),
      heroImage: getVal("s_heroImage"),
      contact: {
        phone: getVal("s_phone"),
        officialEmail: getVal("s_email")
      },
      social: {
        facebook: getVal("s_facebook"),
        instagram: getVal("s_instagram"),
        whatsapp: getVal("s_whatsapp"),
        map: getVal("s_map")
      },
      slider: [
        { img: getVal("s_sl1_img"), link: getVal("s_sl1_link"), caption_ar: getVal("s_sl1_cap_ar"), caption_en: getVal("s_sl1_cap_en") },
        { img: getVal("s_sl2_img"), link: getVal("s_sl2_link"), caption_ar: getVal("s_sl2_cap_ar"), caption_en: getVal("s_sl2_cap_en") },
        { img: getVal("s_sl3_img"), link: getVal("s_sl3_link"), caption_ar: getVal("s_sl3_cap_ar"), caption_en: getVal("s_sl3_cap_en") },
        { img: getVal("s_sl4_img"), link: getVal("s_sl4_link"), caption_ar: getVal("s_sl4_cap_ar"), caption_en: getVal("s_sl4_cap_en") }
      ],
      highlights: [
        { icon: getVal("h1_icon"), k_ar: getVal("h1_k_ar"), v_ar: getVal("h1_v_ar"), k_en: getVal("h1_k_en"), v_en: getVal("h1_v_en") },
        { icon: getVal("h2_icon"), k_ar: getVal("h2_k_ar"), v_ar: getVal("h2_v_ar"), k_en: getVal("h2_k_en"), v_en: getVal("h2_v_en") },
        { icon: getVal("h3_icon"), k_ar: getVal("h3_k_ar"), v_ar: getVal("h3_v_ar"), k_en: getVal("h3_k_en"), v_en: getVal("h3_v_en") },
        { icon: getVal("h4_icon"), k_ar: getVal("h4_k_ar"), v_ar: getVal("h4_v_ar"), k_en: getVal("h4_k_en"), v_en: getVal("h4_v_en") }
      ]
    };

  }

  $("saveSiteBtn")?.addEventListener("click", async ()=>{
    const msgEl = $("siteMsg");
    msgEl.style.display="none";

    if (!isAdmin()) return showHint(msgEl, (LANG==="ar"?"غير مصرح: Admin فقط":"Admin only"), false);

    try{
      const data = getSiteFormData();
      await setDoc(doc(db,"settings","site"), { ...DEFAULT_SITE, ...data, updatedAt: serverTimestamp() }, { merge:true });
      showHint(msgEl, (LANG==="ar"?"تم حفظ إعدادات الموقع ✅":"Site saved ✅"), true);
    }catch(e){
      console.error(e);
      showHint(msgEl, (LANG==="ar"?"فشل الحفظ: ":"Save failed: ")+(e.code||""), false);
    }
  });

  $("resetSiteBtn")?.addEventListener("click", ()=>{
    fillSiteForm();
  });

  // ===== FAQ public render + admin CRUD =====
  
function renderFaqPublic(){
    const wrap = $("faqGrid");
    if (!wrap) return;
    wrap.innerHTML = "";

    if (!FAQS.length) {
      wrap.innerHTML = `<div class="card" style="padding:16px"><h3 style="margin:0 0 8px; font-weight:900">${LANG==="ar"?"لا توجد أسئلة بعد":"No FAQs yet"}</h3><p class="muted" style="margin:0">${LANG==="ar"?"ستظهر الأسئلة هنا بعد إضافتها من لوحة الإدارة.":"FAQ will appear here after adding from Admin panel."}</p></div>`;
      return;
    }

    const qx = (state.faqQ||"").trim().toLowerCase();
    const list = FAQS.filter(x=>{
      if (!qx) return true;
      const q = ((x.q_ar||"")+" "+(x.q_en||"")+" "+(x.a_ar||"")+" "+(x.a_en||"")).toLowerCase();
      return q.includes(qx);
    });

    if (!list.length){
      wrap.innerHTML = `<div class="card" style="padding:16px"><h3 style="margin:0 0 8px; font-weight:900">${LANG==="ar"?"لا توجد نتائج":"No results"}</h3><p class="muted" style="margin:0">${LANG==="ar"?"جرّب كلمة أخرى.":"Try another keyword."}</p></div>`;
      return;
    }

    list.forEach(x=>{
      const q = (LANG==="ar") ? (x.q_ar||"") : (x.q_en||"");
      const a = (LANG==="ar") ? (x.a_ar||"") : (x.a_en||"");
      const card = document.createElement("div");
      card.className="card";
      card.style.padding="16px";
      card.innerHTML = `
        <h3 style="margin:0 0 8px; font-weight:900">${escapeHtml(q)}</h3>
        <p class="muted" style="margin:0">${escapeHtml(a)}</p>
      `;
      wrap.appendChild(card);
    });
  }


  function renderFaqAdmin(){
    const list = $("faqAdminList");
    if (!list) return;
    list.innerHTML = "";

    if (!isAdmin()){
      list.innerHTML = `<div class="muted">${LANG==="ar"?"لوحة FAQ للأدمن فقط.":"FAQ admin only."}</div>`;
      return;
    }

    FAQS.forEach(x=>{
      const it = document.createElement("div");
      it.className="item";
      it.innerHTML = `
        <div class="meta">
          <b>${escapeHtml(x.q_ar||x.q_en||"")}</b>
          <span>order: ${x.order ?? 0} • id: ${x.id}</span>
        </div>
        <div class="row">
          <button class="btn btn-ghost" data-act="edit"><i class="fa-regular fa-pen-to-square"></i> ${LANG==="ar"?"تعديل":"Edit"}</button>
          <button class="btn btn-ghost danger" data-act="del"><i class="fa-regular fa-trash-can"></i> ${LANG==="ar"?"حذف":"Delete"}</button>
        </div>
      `;
      it.querySelector('[data-act="edit"]').addEventListener("click", ()=>loadFaqToForm(x));
      it.querySelector('[data-act="del"]').addEventListener("click", ()=>delFaq(x.id));
      list.appendChild(it);
    });
  }

  function clearFaqForm(){
    EDITING_FAQ_ID = null;
    ["f_faq_q_ar","f_faq_q_en","f_faq_a_ar","f_faq_a_en"].forEach(id=>$(id) && ($(id).value=""));
    $("f_faq_order") && ($("f_faq_order").value = 1);
  }

  function loadFaqToForm(x){
    EDITING_FAQ_ID = x.id;
    $("f_faq_q_ar").value = x.q_ar || "";
    $("f_faq_q_en").value = x.q_en || "";
    $("f_faq_a_ar").value = x.a_ar || "";
    $("f_faq_a_en").value = x.a_en || "";
    $("f_faq_order").value = x.order ?? 1;
    $("adminPanel").scrollIntoView({behavior:"smooth"});
  }

  async function delFaq(id){
    if (!isAdmin()) return;
    const ok = confirm(LANG==="ar" ? "حذف هذا السؤال؟" : "Delete this FAQ?");
    if (!ok) return;
    const msgEl = $("faqMsg");
    try{
      await deleteDoc(doc(db,"faq",id));
      showHint(msgEl, (LANG==="ar"?"تم الحذف ✅":"Deleted ✅"), true);
      if (EDITING_FAQ_ID===id) clearFaqForm();
    }catch(e){
      console.error(e);
      showHint(msgEl, (LANG==="ar"?"فشل الحذف: ":"Delete failed: ")+(e.code||""), false);
    }
  }

  $("clearFaqBtn")?.addEventListener("click", clearFaqForm);

  $("saveFaqBtn")?.addEventListener("click", async ()=>{
    const msgEl = $("faqMsg");
    msgEl.style.display="none";

    if (!isAdmin()) return showHint(msgEl, (LANG==="ar"?"غير مصرح: Admin فقط":"Admin only"), false);

    const data = {
      q_ar: $("f_faq_q_ar").value.trim(),
      a_ar: $("f_faq_a_ar").value.trim(),
      q_en: $("f_faq_q_en").value.trim(),
      a_en: $("f_faq_a_en").value.trim(),
      order: Number($("f_faq_order").value || 0)
    };

    if (!data.q_ar && !data.q_en) return showHint(msgEl, (LANG==="ar"?"اكتب سؤالاً على الأقل":"Enter a question"), false);

    try{
      if (EDITING_FAQ_ID){
        await updateDoc(doc(db,"faq",EDITING_FAQ_ID), { ...data, updatedAt: serverTimestamp() });
      } else {
        await addDoc(collection(db,"faq"), { ...data, createdAt: serverTimestamp() });
      }
      showHint(msgEl, (LANG==="ar"?"تم الحفظ ✅":"Saved ✅"), true);
      clearFaqForm();
    }catch(e){
      console.error(e);
      showHint(msgEl, (LANG==="ar"?"فشل الحفظ: ":"Save failed: ")+(e.code||""), false);
    }
  });

  // ===== Live subscriptions (settings + faq) =====
  // ملاحظة: تحتاج Rules تسمح بالقراءة العامة لـ settings/site و faq
  try{
    onSnapshot(doc(db,"settings","site"), async (snap)=>{
      if (!snap.exists()) {
        // لا تنشئ المستند تلقائياً إلا إذا كان أدمن (قد تمنع القواعد هذا)
        if (isAdmin()) {
          await setDoc(doc(db,"settings","site"), { ...DEFAULT_SITE, createdAt: serverTimestamp() }, { merge:true });
        }
        SITE = DEFAULT_SITE;
        applySite();
        fillSiteForm();
        return;
      }
      SITE = snap.data();
      applySite();
      fillSiteForm();
      renderCompare();
    }, (err)=>{
      console.warn("settings/site snapshot error", err);
      SITE = DEFAULT_SITE;
      applySite();
    });
  }catch(e){
    console.warn("settings snapshot setup error", e);
  }

  try{
    const faqQ = query(collection(db,"faq"), orderBy("order","asc"));
    onSnapshot(faqQ, (snap)=>{
      FAQS = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      renderFaqPublic();
      renderFaqAdmin();
    }, (err)=>{
      console.warn("faq snapshot error", err);
      FAQS = [];
      renderFaqPublic();
    });
  }catch(e){
    console.warn("faq snapshot setup error", e);
  }


  // Modal
  function openModal() {
    $("loginModal").style.display = "block";
    $("loginMsg").style.display = "none";
    $("roleHint").style.display = "none";
  }
  function closeModal() {
    $("loginModal").style.display = "none";
  }

  // Cart modal
  function openCart() {
    $("cartModal").style.display = "block";
    $("cartMsg").style.display = "none";
    renderCart();
  }
  function closeCart() {
    $("cartModal").style.display = "none";
  }

  $("cartBtn").addEventListener("click", openCart);
  $("closeCart").addEventListener("click", closeCart);
  $("cartModal").addEventListener("click", (e)=>{ if (e.target.id==="cartModal") closeCart(); });


  // ===== Drawer (Hamburger) =====
  function openDrawer(){
    $("drawerBackdrop").classList.add("show");
    $("mobileDrawer").classList.add("open");
    $("drawerBackdrop").setAttribute("aria-hidden","false");
    $("mobileDrawer").setAttribute("aria-hidden","false");
    // focus close for accessibility
    $("drawerClose").focus({preventScroll:true});
  }
  function closeDrawer(){
    $("drawerBackdrop").classList.remove("show");
    $("mobileDrawer").classList.remove("open");
    $("drawerBackdrop").setAttribute("aria-hidden","true");
    $("mobileDrawer").setAttribute("aria-hidden","true");
  }
  $("hamburgerBtn")?.addEventListener("click", openDrawer);
  $("drawerClose")?.addEventListener("click", closeDrawer);
  $("drawerBackdrop")?.addEventListener("click", closeDrawer);
  $("mobileDrawer")?.querySelectorAll('a[href^="#"]').forEach(a=>a.addEventListener("click", closeDrawer));
  $("drawerLoginBtn")?.addEventListener("click", ()=>{ closeDrawer(); openModal(); });
  $("drawerCartBtn")?.addEventListener("click", ()=>{ closeDrawer(); openCart(); });

  // Keep drawer cart count in sync
  Bus.on("cart:saved", ()=>{ $("drawerCartCount") && ($("drawerCartCount").textContent = String($("cartCount").textContent||"0")); });

  // ===== Filters =====
  $("categoryFilter")?.addEventListener("change", (e)=>{
    state.category = e.target.value || "all";
    saveUiSettings();
    renderProducts();
  });
  $("productSearch")?.addEventListener("input", (e)=>{
    state.q = e.target.value || "";
    saveUiSettings();
    renderProducts();
  });
  $("clearFilters")?.addEventListener("click", ()=>{
    state.category="all"; state.q="";
    saveUiSettings();
    renderProducts();
  });

  // ===== FAQ search =====
  $("faqSearch")?.addEventListener("input", (e)=>{
    state.faqQ = e.target.value || "";
    saveUiSettings();
    renderFaqPublic();
  });

  // ===== Coupon =====
  async function applyCouponCode(codeRaw){
    const msg = $("couponHint");
    if (!msg) return;
    msg.style.display="block";
    const code = String(codeRaw||"").trim().toUpperCase();
    if (!code){ state.coupon=null; saveUiSettings(); renderCart(); msg.style.display="none"; return; }

    // basic validation
    if (!/^[A-Z0-9_-]{3,16}$/.test(code)){
      msg.textContent = (LANG==="ar") ? "كود غير صالح" : "Invalid code";
      return;
    }
    try{
      const snap = await getDoc(doc(db,"coupons",code));
      if (!snap.exists()){
        msg.textContent = (LANG==="ar") ? "الكود غير موجود" : "Code not found";
        return;
      }
      const c = snap.data() || {};
      if (c.active === false){
        msg.textContent = (LANG==="ar") ? "الكود غير فعال" : "Code inactive";
        return;
      }
      if (c.expiresAt && c.expiresAt.toDate){
        const exp = c.expiresAt.toDate().getTime();
        if (Date.now() > exp){
          msg.textContent = (LANG==="ar") ? "انتهت صلاحية الكود" : "Code expired";
          return;
        }
      }
      const percent = Number(c.percent||0);
      const amount_jod = Number(c.amount_jod||0);
      const amount_usd = Number(c.amount_usd||0);

      if (!(percent>0) && !(amount_jod>0 || amount_usd>0)){
        msg.textContent = (LANG==="ar") ? "الكود غير مُعرّف بشكل صحيح" : "Code misconfigured";
        return;
      }

      state.coupon = { code, percent: percent>0?percent:null, amount_jod: amount_jod>0?amount_jod:null, amount_usd: amount_usd>0?amount_usd:null };
      saveUiSettings();
      renderCart();
    }catch(e){
      console.error(e);
      msg.textContent = (LANG==="ar") ? "تعذر التحقق من الكود" : "Couldn't verify code";
    }
  }
  $("applyCoupon")?.addEventListener("click", ()=> applyCouponCode($("couponInput").value));
  $("couponInput")?.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); applyCouponCode($("couponInput").value); } });

  // ===== Rating =====
  async function submitRating(productId, value){
    const rl = rateLimit(RATE_RATE_KEY, {windowMs: 60_000, max: 8});
    if (!rl.ok){
      alert((LANG==="ar") ? "تم إرسال تقييمات كثيرة. حاول لاحقًا." : "Too many ratings. Try later.");
      return;
    }
    const cid = getClientId();
    try{
      // write unique rating per (product, client)
      const rid = `${productId}_${cid}`;
      const rref = doc(db,"ratings", rid);
      const prev = await getDoc(rref);
      const prevVal = prev.exists() ? Number(prev.data().value||0) : 0;

      await setDoc(rref, { productId, clientId: cid, value, updatedAt: serverTimestamp() }, { merge:true });

      // update aggregates in product doc (best-effort)
      const pref = doc(db,"products", productId);
      let sumDelta = value;
      let cntDelta = 1;
      if (prevVal>=1 && prevVal<=5){
        sumDelta = value - prevVal;
        cntDelta = 0;
      }
      try{
        await updateDoc(pref, { ratingSum: (Number((PRODUCTS.find(p=>p.id===productId)?.ratingSum)||0) + sumDelta), ratingCount: (Number((PRODUCTS.find(p=>p.id===productId)?.ratingCount)||0) + cntDelta) });
      }catch(e2){
        // ignore (security rules may block)
      }

      // local optimistic update
      const p = PRODUCTS.find(x=>x.id===productId);
      if (p){
        p.ratingSum = (Number(p.ratingSum||0) + sumDelta);
        p.ratingCount = (Number(p.ratingCount||0) + cntDelta);
        p.ratingAvg = (p.ratingCount ? (Number(p.ratingSum||0)/Number(p.ratingCount||1)) : 0);
      }
      renderProducts();
    }catch(e){
      console.error(e);
      alert((LANG==="ar") ? "فشل حفظ التقييم" : "Failed to save rating");
    }
  }

  // ===== Export compare table to PDF =====
  $("exportComparePDF")?.addEventListener("click", ()=>{
    try{
      const el = document.querySelector("#compareTable");
      if (!el) return alert((LANG==="ar") ? "لا يوجد جدول" : "No table");
      const { jsPDF } = window.jspdf || {};
      if (!jsPDF) return alert("jsPDF not loaded");
      const docp = new jsPDF({orientation:"landscape", unit:"pt", format:"a4"});
      docp.setFontSize(12);
      docp.text((LANG==="ar") ? "مقارنة الإصدارات" : "Products comparison", 40, 30);

      // Extract headers + rows
      const headers = [...el.querySelectorAll("thead th")].map(th=>th.innerText.trim());
      const rows = [...el.querySelectorAll("tbody tr")].map(tr=>[...tr.children].map(td=>td.innerText.trim()));

      docp.autoTable({ head: [headers], body: rows, startY: 50, styles:{fontSize:9, cellPadding:4} });
      docp.save("compare.pdf");
    }catch(e){
      console.error(e);
      alert((LANG==="ar") ? "فشل التصدير" : "Export failed");
    }
  });


  
function loadCart() {
    try {
      const raw = localStorage.getItem(CART_KEY);
      CART = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(CART)) CART = [];
    } catch(e) { CART = []; }
    // Ensure meta exists
    try{
      const metaRaw = localStorage.getItem(CART_KEY+"_meta");
      if (!metaRaw){
        localStorage.setItem(CART_KEY+"_meta", JSON.stringify({ ts: Date.now(), id: (crypto?.randomUUID?crypto.randomUUID():(""+Date.now())) }));
      }
    }catch(e){}
    updateCartCount();
  }

  
function saveCart() {
    try {
      const meta = { ts: Date.now(), id: (JSON.parse(localStorage.getItem(CART_KEY+"_meta")||"{}").id) || (crypto?.randomUUID?crypto.randomUUID():(""+Date.now())) };
      localStorage.setItem(CART_KEY, JSON.stringify(CART));
      localStorage.setItem(CART_KEY+"_meta", JSON.stringify(meta));
    } catch(e) {}
    updateCartCount();
    Bus.emit("cart:saved", {len:CART.length});
  }

  function updateCartCount() {
    const c = CART.reduce((a,it)=>a + (Number(it.qty)||0), 0);
    $("cartCount").textContent = String(c);
  }

  function money(n, cur) {
    const v = Number(n||0);
    if (cur === "JOD") return v.toFixed(0) + " د.أ";
    if (cur === "USD") return "$" + v.toFixed(0);
    return v.toFixed(0) + " " + (cur||"");
  }

  function totalsByCurrency() {
    const out = {};
    CART.forEach(it=>{
      const cur = it.currency || "JOD";
      out[cur] = (out[cur] || 0) + (Number(it.unitPrice||0) * Number(it.qty||0));
    });
    return out;
  }

  
function calcDiscountForCurrency(subTotal, cur){
    if (!state.coupon) return 0;
    const c = state.coupon;
    if (c.percent && c.percent>0){
      return Math.max(0, Math.min(subTotal, subTotal*(c.percent/100)));
    }
    if (c.amount_jod!=null || c.amount_usd!=null){
      const amt = (cur==="JOD") ? Number(c.amount_jod||0) : Number(c.amount_usd||0);
      return Math.max(0, Math.min(subTotal, amt));
    }
    return 0;
  }

  function renderCart() {
    const body = $("cartBody");
    body.innerHTML = "";

    if (!CART.length) {
      body.innerHTML = `<div class="muted" style="text-align:center; font-weight:900">${i18n[LANG].cart_empty}</div>`;
      $("cartSubTotalVal").textContent = "0";
      $("cartDiscountVal").textContent = "0";
      $("cartTotalVal").textContent = "0";
      return;
    }

    CART.forEach((it, idx)=>{
      const p = PRODUCTS.find(x=>x.id===it.productId);
      const thumb = (p && p.image) ? p.image : "";
      const line = document.createElement("div");
      line.className = "cart-line";
      line.innerHTML = `
        <div style="display:flex; gap:10px; align-items:flex-start">
          <div style="width:58px; height:58px; border-radius:16px; overflow:hidden; border:1px solid var(--line); background:#fff; flex:0 0 auto">
            ${thumb?`<img src="${thumb}" alt="" loading="lazy" decoding="async" style="width:100%; height:100%; object-fit:cover">`:`<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:var(--muted)"><i class="fa-regular fa-image"></i></div>`}
          </div>
          <div style="display:grid; gap:4px">
            <div style="font-weight:900">${escapeHtml(it.name||"")}</div>
            <div class="muted" style="font-size:13px; font-weight:900">${money(it.unitPrice, it.currency)} • ${it.currency}</div>
          </div>
        </div>
        <div style="display:grid; gap:8px; justify-items:end">
          <div class="qty">
            <button type="button" data-act="minus" aria-label="minus">−</button>
            <span>${Number(it.qty||1)}</span>
            <button type="button" data-act="plus" aria-label="plus">+</button>
          </div>
          <button type="button" class="btn btn-ghost danger" style="padding:8px 10px" data-act="rm"><i class="fa-regular fa-trash-can"></i> ${i18n[LANG].cart_remove}</button>
        </div>
      `;
      line.querySelector('[data-act="minus"]').addEventListener("click", ()=>{
        it.qty = Math.max(1, (Number(it.qty)||1) - 1);
        CART[idx]=it; saveCart(); renderCart();
      });
      line.querySelector('[data-act="plus"]').addEventListener("click", ()=>{
        it.qty = (Number(it.qty)||1) + 1;
        CART[idx]=it; saveCart(); renderCart();
      });
      line.querySelector('[data-act="rm"]').addEventListener("click", ()=>{
        CART.splice(idx,1); saveCart(); renderCart();
      });
      body.appendChild(line);
    });

    const subTotals = totalsByCurrency();
    const subParts = Object.entries(subTotals).map(([cur,val])=>money(val,cur));
    const discounts = Object.entries(subTotals).reduce((acc,[cur,val])=>{
      acc[cur] = calcDiscountForCurrency(val, cur);
      return acc;
    }, {});
    const totalParts = Object.entries(subTotals).map(([cur,val])=>money(Math.max(0,val - (discounts[cur]||0)), cur));
    const discParts = Object.entries(discounts).filter(([_,v])=>v>0).map(([cur,val])=>money(val,cur));

    $("cartSubTotalVal").textContent = subParts.join("  |  ");
    $("cartDiscountVal").textContent = discParts.length ? ("− " + discParts.join("  |  ")) : "0";
    $("cartTotalVal").textContent = totalParts.join("  |  ");

    // coupon hint
    const hint = $("couponHint");
    if (hint){
      if (state.coupon){
        hint.style.display="block";
        const label = (LANG==="ar") ? "تم تطبيق الكود" : "Coupon applied";
        hint.textContent = `${label}: ${state.coupon.code}`;
      } else {
        hint.style.display="none";
      }
    }

    Bus.emit("cart:rendered", {items:CART.length});
  }


  window.__addToCart = (productId)=>{
    const p = PRODUCTS.find(x=>x.id===productId);
    if (!p) return;

    const cur = (LANG==="ar") ? "JOD" : "USD";
    const unit = (LANG==="ar") ? Number(p.price_jod_retail||0) : Number(p.price_usd_retail||0);

    const existing = CART.find(x=>x.productId===productId && x.currency===cur && Number(x.unitPrice||0)===unit);
    if (existing) {
      existing.qty = (Number(existing.qty)||1) + 1;
    } else {
      CART.push({ productId, name: p.name||"", unitPrice: unit, currency: cur, qty: 1 });
    }
    saveCart();
    showHint($("cartMsg"), i18n[LANG].cart_added, true);
    openCart();
  };

  $("loginBtn").addEventListener("click", openModal);
  $("closeModal").addEventListener("click", closeModal);
  $("loginModal").addEventListener("click", (e)=>{ if (e.target.id==="loginModal") closeModal(); });

  async function doLogin() {
    const email = $("loginEmail").value.trim();
    const pass  = $("loginPass").value;
    $("loginMsg").style.display="none";
    try {
      await signInWithEmailAndPassword(auth, email, pass);
      closeModal();
    } catch (e) {
      $("loginMsg").style.display="block";
      $("loginMsg").textContent = (LANG==="ar") ? ("فشل الدخول: " + (e.code||"")) : ("Login failed: " + (e.code||""));
    }
  }
  $("doLogin").addEventListener("click", doLogin);

  
async function placeOrder() {
    const msgEl = $("cartMsg");
    msgEl.style.display="none";

    // Rate limit (client-side)
    const rl = rateLimit(ORDER_RATE_KEY, {windowMs: 10*60_000, max: 3});
    if (!rl.ok){
      const mins = Math.ceil(rl.retryMs/60_000);
      showHint(msgEl, (LANG==="ar" ? `طلبات كثيرة. حاول بعد ${mins} دقيقة.` : `Too many orders. Try again in ${mins} min.`), false);
      return;
    }

    if (!CART.length) {
      showHint(msgEl, i18n[LANG].cart_empty, false);
      return;
    }

    const customer = {
      name: $("co_name").value.trim(),
      phone: $("co_phone").value.trim(),
      city: $("co_city").value.trim(),
      address: $("co_address").value.trim(),
      note: $("co_note").value.trim(),
    };

    // Validate
    if (customer.name.length < 2 || customer.name.length > 60){
      showHint(msgEl, (LANG==="ar" ? "يرجى إدخال اسم صحيح" : "Please enter a valid name"), false);
      return;
    }
    if (!isValidPhoneJO(customer.phone)){
      showHint(msgEl, (LANG==="ar" ? "رقم الهاتف غير صحيح (مثال: 079xxxxxxx)" : "Invalid phone number"), false);
      return;
    }
    if (customer.city.length < 2 || customer.city.length > 40){
      showHint(msgEl, (LANG==="ar" ? "يرجى إدخال المدينة" : "Please enter city"), false);
      return;
    }
    if (customer.address.length < 5 || customer.address.length > 140){
      showHint(msgEl, (LANG==="ar" ? "يرجى إدخال العنوان بشكل أوضح" : "Please enter a clearer address"), false);
      return;
    }
    if (customer.note.length > 300){
      showHint(msgEl, (LANG==="ar" ? "الملاحظة طويلة جدًا" : "Note is too long"), false);
      return;
    }

    // Totals
    const subTotals = totalsByCurrency();
    const discounts = Object.entries(subTotals).reduce((acc,[cur,val])=>{
      acc[cur] = calcDiscountForCurrency(val, cur);
      return acc;
    }, {});
    const totals = Object.entries(subTotals).reduce((acc,[cur,val])=>{
      acc[cur] = Math.max(0, val - (discounts[cur]||0));
      return acc;
    }, {});

    const payload = {
      items: CART.map(it=>({
        productId: it.productId,
        name: it.name,
        unitPrice: Number(it.unitPrice||0),
        currency: it.currency||"JOD",
        qty: Number(it.qty||1),
      })),
      customer,
      coupon: state.coupon ? { code: state.coupon.code, percent: state.coupon.percent||null, amount_jod: state.coupon.amount_jod||null, amount_usd: state.coupon.amount_usd||null } : null,
      totals: { subTotals, discounts, totals },
      meta: {
        lang: LANG,
        clientId: getClientId(),
        ua: navigator.userAgent,
        createdAt: serverTimestamp(),
      }
    };

    try {
      await addDoc(collection(db,"orders"), payload);
      CART = [];
      state.coupon = null;
      saveUiSettings();
      saveCart();
      renderCart();
      showHint(msgEl, i18n[LANG].cart_saved, true);
      setTimeout(()=>{ closeCart(); }, 900);
      ["co_name","co_phone","co_city","co_address","co_note"].forEach(id=>$(id).value="");
      if ($("couponInput")) $("couponInput").value="";
    } catch(e) {
      console.error("Order error:", e);
      showHint(msgEl, (i18n[LANG].cart_failed + ": " + (e.code||"")), false);
    }
  }

  $("placeOrder").addEventListener("click", placeOrder);

  $("logoutBtn").addEventListener("click", async ()=>{ await signOut(auth); });

  async function loadRole(uid) {
    ROLE = "retail";
    try {
      const snap = await getDoc(doc(db,"users",uid));
      if (snap.exists() && snap.data()?.role) ROLE = String(snap.data().role);
    } catch(e) {}
  }

  function isAdmin() { return ROLE === "admin"; }

  function updateHeader() {
    if (USER) {
      $("userPill").style.display="inline-flex";
      $("userText").textContent = (USER.email||USER.uid) + " • " + ROLE.toUpperCase();
      $("loginBtn").style.display="none";
      $("logoutBtn").style.display="inline-flex";
    } else {
      $("userPill").style.display="none";
      $("loginBtn").style.display="inline-flex";
      $("logoutBtn").style.display="none";
      $("adminNavBtn").style.display="none";
      $("adminPanel").style.display="none";
    }
  }

  function toggleAdminUI() {
    $("adminPanel").style.display = isAdmin() ? "block" : "none";
    $("adminNavBtn").style.display = isAdmin() ? "inline-flex" : "none";
    document.body.classList.toggle("is-admin", isAdmin());
  }

  $("adminNavBtn").addEventListener("click", ()=>{ $("adminPanel").scrollIntoView({behavior:"smooth"}); });

  // Products
  
  function renderSpecsHTML(p){
    const arr = Array.isArray(p.specs) ? p.specs.map(x=>String(x).trim()).filter(Boolean) : [];
    if (!arr.length) return "";
    const title = (LANG==="ar") ? "مواصفات" : "Specs";
    const lis = arr.slice(0,8).map(s=>`<li>${escapeHtml(s)}</li>`).join("");
    return `<div class="p-specs"><b>${title}</b><ul class="spec">${lis}</ul></div>`;
  }


function renderProducts() {
    const grid = $("productsGrid");
    const empty = $("productsEmpty");
    const loader = $("productsLoader");
    if (loader) loader.classList.toggle("show", !!state.productsLoading);

    // Build categories from products
    const cats = Array.from(new Set(PRODUCTS.map(p => (p.category || "").trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
    const sel = $("categoryFilter");
    if (sel) {
      const allLabel = (LANG==="ar") ? "كل الفئات" : "All categories";
      const optAll = `<option value="all">${allLabel}</option>`;
      const optCats = cats.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
      sel.innerHTML = optAll + optCats;
      sel.value = state.category || "all";
    }
    const ps = $("productSearch");
    if (ps) {
      ps.placeholder = (LANG==="ar") ? "بحث في المنتجات..." : "Search products...";
      ps.value = state.q || "";
    }
    const lt = $("productsLoaderText");
    if (lt) lt.textContent = (LANG==="ar") ? "جاري تحميل المنتجات..." : "Loading products...";

    // Filter
    const q = (state.q || "").trim().toLowerCase();
    const list = PRODUCTS.filter(p=>{
      const catOk = (state.category==="all" || !state.category) ? true : ((p.category||"").trim() === state.category);
      if (!catOk) return false;
      if (!q) return true;
      const hay = ((p.name||"")+" "+(p.badge||"")+" "+(Array.isArray(p.features)?p.features.join(" "):"")).toLowerCase();
      return hay.includes(q);
    });

    grid.innerHTML = "";
    if (empty) empty.style.display = (!state.productsLoading && list.length===0) ? "block" : "none";

    const frag = document.createDocumentFragment();

    list.forEach(p=>{
      const img = (p.image || "").trim() || "https://images.unsplash.com/photo-1593941707882-a5bba14938c7?auto=format&fit=crop&w=600&q=80";
      const feats = Array.isArray(p.features) ? p.features : [];
      const price = (LANG==="ar") ? p.price_jod_retail : p.price_usd_retail;

      const oldPriceRaw = (LANG==="ar") ? p.old_price_jod_retail : p.old_price_usd_retail;
      let oldPrice = (oldPriceRaw!=null && oldPriceRaw!=="" && !isNaN(Number(oldPriceRaw))) ? Number(oldPriceRaw) : null;
      let disc = (p.discount_percent!=null && p.discount_percent!=="" && !isNaN(Number(p.discount_percent))) ? Number(p.discount_percent) : null;
      const curPrice = (price!=null && price!=="" && !isNaN(Number(price))) ? Number(price) : null;

      if ((oldPrice==null || !(oldPrice>0)) && disc!=null && disc>0 && disc<96 && curPrice!=null && curPrice>0) {
        oldPrice = +(curPrice / (1 - disc/100)).toFixed(2);
      }
      if ((disc==null || !(disc>0)) && oldPrice!=null && curPrice!=null && oldPrice>curPrice && oldPrice>0) {
        disc = Math.round(((oldPrice-curPrice)/oldPrice)*100);
      }

      const discBadge = (disc!=null && disc>0) ? `<div class="p-discount">${LANG==="ar" ? ("خصم "+disc+"%") : (disc+"% OFF")}</div>` : "";
      const oldPriceHTML = (oldPrice!=null && curPrice!=null && oldPrice>curPrice) ? `<div class="p-old">${fmtPrice(oldPrice)}</div>` : "";

      // Rating
      const count = Number(p.ratingCount || 0) || 0;
      const avg = Number(p.ratingAvg || (count ? (Number(p.ratingSum||0)/count) : 0)) || 0;
      const avgTxt = count ? avg.toFixed(1) : (LANG==="ar" ? "بدون تقييم" : "No ratings");

      const card = document.createElement("div");
      card.className = "card p-card";
      card.innerHTML = `
        <div class="p-top">
          <div class="p-img">
            <img data-src="${img}" alt="${escapeHtml(p.name||'product')}" loading="lazy" decoding="async">
          </div>
          <div style="flex:1">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap">
              <div class="p-badge">${badgeText(p.badge)} </div>
              ${(p.category||"").trim()?`<span class="badge-mini">${escapeHtml((p.category||"").trim())}</span>`:""}
            </div>
            <h3 class="p-name">${escapeHtml(p.name||"")}</h3>
            <div class="p-price-row">
              <div class="p-price">${fmtPrice(price)}</div>
              ${discBadge}
            </div>
            ${oldPriceHTML}
            <div class="rating-meta">
              <div class="stars" data-pid="${p.id}">
                ${[1,2,3,4,5].map(n=>`<button class="star ${(avg>=n-0.25)?'on':''}" data-rate="${n}" aria-label="rate ${n}">★</button>`).join("")}
              </div>
              <span class="badge-mini">${escapeHtml(avgTxt)}${count?` • ${count}`:""}</span>
            </div>
            <div class="muted" style="margin-top:4px">${LANG==="ar" ? "عمّان - الأردن" : "Amman, Jordan"}</div>
          </div>
        </div>
        <ul class="feat">
          ${feats.slice(0,6).map(f=>`<li><i class="fa-solid fa-circle-check"></i> ${escapeHtml(String(f).trim())}</li>`).join("")}
        </ul>
        ${renderSpecsHTML(p)}
        <div class="p-actions">
          <a class="btn btn-ghost" href="${safeUrl(p.software)}" target="_blank" rel="noopener"><i class="fa-solid fa-download"></i> ${i18n[LANG].btn_sw}</a>
          <a class="btn btn-ghost" href="${safeUrl(p.catalog)}" target="_blank" rel="noopener"><i class="fa-regular fa-file-pdf"></i> ${i18n[LANG].btn_cat}</a>
          <a class="btn btn-ghost" href="${safeUrl(p.video)}" target="_blank" rel="noopener"><i class="fa-solid fa-play"></i> ${i18n[LANG].btn_vid}</a>
          <button class="btn btn-primary" data-add="${p.id}" style="margin-inline-start:auto"><i class="fa-solid fa-cart-shopping"></i> ${i18n[LANG].btn_order}</button>
        </div>
      `;
      frag.appendChild(card);
    });

    grid.appendChild(frag);

    // Lazy load images with IntersectionObserver
    lazyLoadImages();

    // Bind actions
    grid.querySelectorAll('button[data-add]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-add");
        const p = PRODUCTS.find(x=>x.id===id);
        if (p && window.__addToCart) window.__addToCart(p.id);
      });
    });

    // Rating clicks
    grid.querySelectorAll('.stars').forEach(st=>{
      st.addEventListener("click", async (e)=>{
        const b = e.target.closest("button.star");
        if (!b) return;
        const pid = st.getAttribute("data-pid");
        const v = Number(b.getAttribute("data-rate"));
        if (!pid || !(v>=1 && v<=5)) return;
        await submitRating(pid, v);
      });
    });

    Bus.emit("products:rendered", {count:list.length});
  }


  function renderCompare() {
    const tbl = $("compareTable");
    const cols = PRODUCTS.slice(0,4);

    const s = SITE || DEFAULT_SITE;
    const feats = Array.isArray(s.compareFeatures) ? s.compareFeatures : DEFAULT_SITE.compareFeatures;

    const head = `
      <thead>
        <tr>
          <th>${LANG==="ar" ? "الميزة" : "Feature"}</th>
          ${cols.map(p=>`<th>${escapeHtml(p.name||"")}<br><small>${fmtPrice(LANG==="ar"?p.price_jod_retail:p.price_usd_retail)}</small></th>`).join("")}
        </tr>
      </thead>
    `;

    const bodyRows = feats.map(f=>{
      const label = (LANG==="ar") ? (f.ar||f.key) : (f.en||f.key);
      return `
        <tr>
          <td>${escapeHtml(label)}</td>
          ${cols.map(p=>{
            const val = (p.compare && (f.key in p.compare)) ? p.compare[f.key] : null;
            if (f.type === "bool") {
              const b = (val===true) ? "✓" : "—";
              return `<td>${b}</td>`;
            }
            return `<td>${escapeHtml(String(val ?? "—"))}</td>`;
          }).join("")}
        </tr>
      `;
    }).join("");

    tbl.innerHTML = head + `<tbody>${bodyRows}</tbody>`;
  }

  // Live products subscription
  const qy = query(collection(db,"products"), orderBy("createdAt","desc"));
  onSnapshot(qy, (snap)=>{
    state.productsLoading = false;
    PRODUCTS = snap.docs.map(d=>({ id:d.id, ...d.data() }));
// extra labels not covered by data-i18n
    const d1 = $("cartDiscountLabel"); if (d1) d1.textContent = (LANG==="ar") ? "الخصم" : "Discount";
    const d2 = $("cartAfterLabel"); if (d2) d2.textContent = (LANG==="ar") ? "الإجمالي بعد الخصم" : "Total after discount";
    const cInp = $("couponInput"); if (cInp) cInp.placeholder = (LANG==="ar") ? "مثال: SAVE10" : "e.g. SAVE10";
    const pSearch = $("productSearch"); if (pSearch) pSearch.placeholder = (LANG==="ar") ? "بحث في المنتجات..." : "Search products...";
    const fSearch = $("faqSearch"); if (fSearch) fSearch.placeholder = (LANG==="ar") ? "بحث داخل الأسئلة..." : "Search FAQs...";
    saveUiSettings();
    renderCart();

    renderProducts();
    renderCompare();
    renderAdminList();
  }, (err)=>{ console.error("Firestore snapshot error:", err); state.productsLoading=false; renderProducts(); });

  // Admin CRUD
  function numOrNull(v) {
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }

  function getFormData() {
    const features = $("f_features").value.split("\n").map(s=>s.trim()).filter(Boolean);
    const specs = $("f_specs") ? $("f_specs").value.split("\n").map(s=>s.trim()).filter(Boolean) : [];
    return {
      name: $("f_name").value.trim(),
      category: ($("f_category")?$("f_category").value.trim():""),
      badge: $("f_badge").value,
      image: $("f_img").value.trim(),
      video: $("f_video").value.trim(),
      software: $("f_software").value.trim(),
      catalog: $("f_catalog").value.trim(),
      features,
      specs,
      price_jod_retail: numOrNull($("f_price_jod_retail").value),
      price_jod_trade:  numOrNull($("f_price_jod_trade").value),
      price_usd_retail: numOrNull($("f_price_usd_retail").value),
      price_usd_trade:  numOrNull($("f_price_usd_trade").value),
      old_price_jod_retail: numOrNull($("f_old_price_jod_retail")?.value),
      old_price_usd_retail: numOrNull($("f_old_price_usd_retail")?.value),
      discount_percent: numOrNull($("f_discount_percent")?.value),
      compare: {
        power: $("c_power")?.value.trim() || "",
        protection: $("c_protection")?.value.trim() || "",
        interface: !!$("c_interface")?.checked,
        schedule: !!$("c_schedule")?.checked,
        remote: !!$("c_remote")?.checked,
        voice: !!$("c_voice")?.checked,
      },
      // حقول سريعة للاستفادة في العرض (اختياري)
      remote: !!$("c_remote")?.checked,
      voice: !!$("c_voice")?.checked,
    };
  }

  function clearForm() {
    EDITING_ID = null;
    ["f_name","f_category","f_img","f_video","f_software","f_catalog","f_features","f_price_jod_retail","f_price_jod_trade","f_price_usd_retail","f_price_usd_trade","f_old_price_jod_retail","f_old_price_usd_retail","f_discount_percent"].forEach(id=>$(id) && ($(id).value=""));
    ["c_power","c_protection"].forEach(id=>$(id) && ($(id).value=""));
    ["c_interface","c_schedule","c_remote","c_voice"].forEach(id=>$(id) && ($(id).checked=false));
    $("f_badge").value="new";
  }

  $("clearBtn").addEventListener("click", clearForm);

  $("saveBtn").addEventListener("click", async ()=>{
    const msgEl = $("adminMsg");
    msgEl.style.display="none";

    if (!isAdmin()) {
      showHint(msgEl, (LANG==="ar" ? "غير مصرح: Admin فقط" : "Not allowed: Admin only"), false);
      return;
    }

    const data = getFormData();
    if (!data.name) {
      showHint(msgEl, (LANG==="ar" ? "يرجى إدخال اسم المنتج" : "Please enter a product name"), false);
      return;
    }

    try {
      if (EDITING_ID) {
        await updateDoc(doc(db,"products",EDITING_ID), {...data, updatedAt: serverTimestamp()});
      } else {
        await addDoc(collection(db,"products"), {...data, createdAt: serverTimestamp()});
      }
      showHint(msgEl, i18n[LANG].saved_ok, true);
      clearForm();
    } catch(e) {
      console.error("Save error:", e);
      showHint(msgEl, (LANG==="ar" ? "فشل الحفظ: " : "Save failed: ") + (e.code||""), false);
    }
  });

  function renderAdminList() {
    const list = $("adminList");
    list.innerHTML = "";

    if (!isAdmin()) {
      list.innerHTML = `<div class="muted">${LANG==="ar" ? "لوحة الإدارة للأدمن فقط." : "Admin only."}</div>`;
      return;
    }

    PRODUCTS.forEach(p=>{
      const it = document.createElement("div");
      it.className = "item";
      it.innerHTML = `
        <div class="meta">
          <b>${escapeHtml(p.name||"")}</b>
          <span>${fmtPrice(LANG==="ar"?p.price_jod_retail:p.price_usd_retail)} • id: ${p.id}</span>
        </div>
        <div class="row">
          <button class="btn btn-ghost" data-act="edit"><i class="fa-regular fa-pen-to-square"></i> ${i18n[LANG].admin_edit}</button>
          <button class="btn btn-ghost danger" data-act="del"><i class="fa-regular fa-trash-can"></i> ${i18n[LANG].admin_delete}</button>
        </div>
      `;
      it.querySelector('[data-act="edit"]').addEventListener("click", ()=>loadToForm(p));
      it.querySelector('[data-act="del"]').addEventListener("click", ()=>delProduct(p.id));
      list.appendChild(it);
    });
  }

  function loadToForm(p) {
    EDITING_ID = p.id;
    $("f_name").value = p.name||"";
    if ($("f_category")) $("f_category").value = p.category||"";
    $("f_badge").value = p.badge||"new";
    $("f_img").value = p.image||"";
    $("f_video").value = p.video||"";
    $("f_software").value = p.software||"";
    $("f_catalog").value = p.catalog||"";
    $("f_features").value = (Array.isArray(p.features)?p.features:[]).join("\n");
    $("f_price_jod_retail").value = p.price_jod_retail ?? "";
    $("f_price_jod_trade").value  = p.price_jod_trade ?? "";
    $("f_price_usd_retail").value = p.price_usd_retail ?? "";
    $("f_price_usd_trade").value  = p.price_usd_trade ?? "";
    $("f_old_price_jod_retail").value = p.old_price_jod_retail ?? "";
    $("f_old_price_usd_retail").value = p.old_price_usd_retail ?? "";
    $("f_discount_percent").value = p.discount_percent ?? "";
    $("c_power").value = p.compare?.power || "";
    $("c_protection").value = p.compare?.protection || "";
    $("c_interface").checked = !!p.compare?.interface;
    $("c_schedule").checked = !!p.compare?.schedule;
    $("c_remote").checked = !!p.compare?.remote;
    $("c_voice").checked = !!p.compare?.voice;
    $("adminPanel").scrollIntoView({behavior:"smooth"});
  }

  async function delProduct(id) {
    if (!isAdmin()) return;
    const ok = confirm(LANG==="ar" ? "هل تريد حذف المنتج؟" : "Delete product?");
    if (!ok) return;
    const msgEl = $("adminMsg");
    try {
      await deleteDoc(doc(db,"products",id));
      showHint(msgEl, i18n[LANG].deleted_ok, true);
      if (EDITING_ID===id) clearForm();
    } catch(e) {
      console.error("Delete error:", e);
      showHint(msgEl, (LANG==="ar" ? "فشل الحذف: " : "Delete failed: ") + (e.code||""), false);
    }
  }

  onAuthStateChanged(auth, async (u)=>{
    USER = u || null;
    if (USER) {
      await loadRole(USER.uid);
    } else {
      ROLE = "retail";
    }
    updateHeader();
    toggleAdminUI();
    renderAdminList();
    // if logged in but not admin, show hint inside modal if opened
  });

  $("langAR").addEventListener("click", ()=>{ LANG="ar"; applyLang(); });
  $("langEN").addEventListener("click", ()=>{ LANG="en"; applyLang(); });

  $("year").textContent = new Date().getFullYear();
  loadUiSettings();
  loadCart();
  // restore UI inputs
  if ($("couponInput") && state.coupon) $("couponInput").value = state.coupon.code;
  applyLang();
  renderProducts();
  renderFaqPublic();
  renderCart();

  // Service Worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch((e)=>console.warn('SW failed', e));
  }

</script>

</body>
</html>
